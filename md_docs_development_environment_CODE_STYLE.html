<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: Formatter</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_development_environment_CODE_STYLE.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Formatter </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >A lot of the style is now taken care of by the formatter. We currently use clang-format version 14.0.</p>
<p >Investigate the <code>source/.clang-format</code> (<a href="https://github.com/crownstone/bluenet/blob/master/source/.clang-format">https://github.com/crownstone/bluenet/blob/master/source/.clang-format</a>) file for formatting details, a few:</p>
<ul>
<li>align subsequent assignments on the <code>=</code> token</li>
<li>column limit at 120</li>
</ul>
<p >Support for autoformatting in IDEs is widespread. E.g.:</p><ul>
<li>This <a href="https://marketplace.eclipse.org/content/cppstyle">Eclipse plugin</a> enables formatting files on save or selected pieces of code using <code>ctrl+shift+f</code>.</li>
<li>Commandline tools such as <code>python3 -m pip install clang-format</code> are also available.</li>
</ul>
<p >Always run the formatter before committing.</p>
<h2><a class="anchor" id="autotoc_md207"></a>
Helping the formatter</h2>
<p >If the formatter makes something less readible, adjust the code slightly. Some examples of making it easier for the formatter:</p>
<ul>
<li>Use curly brackets for each case in a switch block.</li>
<li>Do not add <code>/******** *******/</code> or other kind of decorations to delineate code sections.</li>
<li>Do not use trailing comments, they are a pain to align. Just explain code with comments before that code.</li>
<li>Remove code that is not in use. There should be no commented code. Eventually place it within a preprocessor clause, but be careful not to introduce code rot in case those preprocessor defines are never compiled for. Refer eventually in a comment to an older commit if a reference to unused code will be important in the future.</li>
</ul>
<h1><a class="anchor" id="autotoc_md208"></a>
Etiquette</h1>
<p >These guidelines help avoiding bugs.</p>
<ul>
<li>Use <code>TYPIFY</code> to get the correct type of an event of state type.</li>
<li>Use <code>static_cast</code>, <code>reinterpret_cast</code>, etc instead of <code>(type)</code> casts.</li>
<li>Keep overloading default operators to a minimum, this makes it hard to find the implementation.</li>
<li>Give names to functions.</li>
<li>Don't init structs like: <code>{ 9, true, 3 }</code>, but use named fields: <code>{ .count = 9, .correct = true, .three = 3 }</code>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md209"></a>
POD types</h2>
<p >Datastructures that cross the boundaries of the application memory (ram) are tied to strict lay-out rules to ensure correct interoperability. In particular this applies to all data types that are used for communication over hardware protocols (bluetooth, flash, uart, etc.).</p>
<p >All such structures must:</p>
<ul>
<li>be defined in <code>./source/include/protocol/</code></li>
<li>be <b>Plain Old Data</b> types (PODs).</li>
<li>be packed <code>struct __attribute__((__packed__)) struct_name_t { /* ... */ };</code></li>
<li>as much as possible ensure that members are aligned on 4 bytes boundaries. E.g.:</li>
</ul>
<div class="fragment"><div class="line">// Bad: memberY straddles 4 byte</div>
<div class="line">struct __attribute__((__packed__)) bad_t {</div>
<div class="line">    uint16_t _memberX;</div>
<div class="line">    uint32_t _memberY;</div>
<div class="line">    uint16_t _memberZ;</div>
<div class="line">};</div>
</div><!-- fragment --><div class="fragment"><div class="line">// Good: placing the two uint16_t&#39;s side by side correctly aligns _memberY</div>
<div class="line">struct __attribute__((__packed__)) good_t {</div>
<div class="line">    uint16_t _memberX;</div>
<div class="line">    uint16_t _memberZ;</div>
<div class="line">    uint32_t _memberY;</div>
<div class="line">};</div>
</div><!-- fragment --><p >Adding methods to datatypes that cross hardware boundaries is possible as long as these definitions do not interfere with the POD property of said type.</p>
<h2><a class="anchor" id="autotoc_md210"></a>
Constants</h2>
<p >There is a strong preference to use typed <code>constexpr</code> values over macros. The use of <code>auto</code> is permitted if the codebase would emit warnings when replacing a macro with a constexprs of particular type.</p>
<div class="fragment"><div class="line">#define BLUETOOTH_NAME &quot;CRWN&quot;                     // &lt;-- obsolete</div>
<div class="line">static constexpr auto BLUETOOTH_NAME   = &quot;CRWN&quot;;  // &lt;-- acceptable</div>
<div class="line">static constexpr char[] BLUETOOTH_NAME = &quot;CRWN&quot;;  // &lt;-- preferred</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md211"></a>
Declare variables on their own line</h2>
<p >This usually makes it easier to read.</p>
<div class="fragment"><div class="line">int a;</div>
<div class="line">int b;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md212"></a>
Use nullptr instead of NULL</h2>
<p >The preprocessor symbol <code>NULL</code> is usually defined as <code>((void*)0)</code>, but it is implementation defined. There are subtle differences between <code>NULL</code> and <code>nullptr</code> due to freedom of implementation. Hence <code>nullptr</code> is preferred or possibly an explicit alternative if <code>nullptr</code> doesn't lead to intended behaviour.</p>
<h2><a class="anchor" id="autotoc_md213"></a>
If statement block must always be in brackets.</h2>
<p >Leaving out brackets easily introduces bugs.</p>
<div class="fragment"><div class="line">if (on) {</div>
<div class="line">    turnOn = true;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md214"></a>
Include what you use</h2>
<p >Each source file <code>filename.cpp</code> file includes its corresponding header <code>filename.h</code>. If a class, struct or function etc., say <code>class someclass{};</code> is defined in <code>otherfilename.h</code>:</p><ul>
<li>If <code>filename.h</code> uses <code>someclass</code>, it should <em>directly</em> <code>#include &lt;otherfilename.h&gt;</code></li>
<li>Else, if <code>filename.cpp</code> uses <code>someclass</code>, it should <em>directly</em> <code>#include &lt;otherfilename.h&gt;</code></li>
</ul>
<p >This paradigm ensures that changing a header does not break any upward dependencies increases awareness of dependencies and make them easier to analyse.</p>
<h1><a class="anchor" id="autotoc_md215"></a>
Naming</h1>
<p >Identifiers follow the following convention, falling back to a previous rule if no specific case is declared for that particular scope.</p>
<ul>
<li>Namespace scope (possibly global):<ul>
<li>classes (non-PODs): <code>UpperCamel</code></li>
<li>structs (PODs): <code>small_caps_t</code></li>
<li>enums: both members and type names currently varying between <code>UpperCamel</code> and <code>ALL_CAPS</code></li>
<li>macros: <code>ALL_CAPS</code></li>
<li>functions: <code>lowerCamel</code></li>
<li>constants: <code>ALL_CAPS</code></li>
<li>templates: same as underlying type</li>
<li>typedefs/aliases: same as underlying type</li>
</ul>
</li>
<li>Class/struct scope:<ul>
<li>variables: <code>_underscoredLowerCamel</code></li>
<li>methods: <code>lowerCamel</code></li>
<li>constants: <code>ALL_CAPS</code></li>
</ul>
</li>
<li>Method/function scope, including their parameters:<ul>
<li>variables: <code>lowerCamel</code></li>
</ul>
</li>
</ul>
<p >In a short overview:</p>
<div class="fragment"><div class="line">#define CS_TYPE_CAST(EVT_NAME, PTR) reinterpret_cast&lt;TYPIFY(EVT_NAME)*&gt;(PTR)</div>
<div class="line"> </div>
<div class="line">static constexpr auto BLUETOOTH_NAME = &quot;CRWN&quot;;</div>
<div class="line"> </div>
<div class="line">class ClassName {</div>
<div class="line">public:</div>
<div class="line">    void functionName();</div>
<div class="line"> </div>
<div class="line">private:</div>
<div class="line">    typedef uint8_t index_t;</div>
<div class="line"> </div>
<div class="line">    uint16_t* _data;</div>
<div class="line"> </div>
<div class="line">    class Settings {</div>
<div class="line">        bool _isActive;</div>
<div class="line">    };</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">using MyVec = std::vector&lt;uint8_t&gt;;</div>
<div class="line"> </div>
<div class="line">struct __attribute__((__packed__)) a_packed_packet_t {</div>
<div class="line">    uint8_t shortWord;</div>
<div class="line">    uint32_t longWord;</div>
<div class="line">};</div>
</div><!-- fragment --><p >Notes:</p><ul>
<li>Abbreviations in identifier are considered to be a whole word in <code>lowerCamel</code> or <code>UpperCamel</code>. Only the first letter of an abbreviation will be upper case. For example: <code>rssiMacAddress</code>.</li>
<li>The convention for variable/member names is chosen to make it easier to recognize their scope and saves you from coming up with alternative names in contexts such as: <div class="fragment"><div class="line">void setRssi(int8_t rssi) {</div>
<div class="line">    _rssi = rssi;</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Avoid use of single letters for identifiers (with the exception of a variable for loop iterations) as it impairs search/replace tools and readability.</li>
<li>Avoid use of names longer than about 35 characters.</li>
<li>Use <code>uint16_t*</code> with no space in between (not <code>uint16_t *_data</code>). Do not declare multiple variables on one line (see below).</li>
<li>Assume C++ / g++ compiler in the sense that no <code>typedef</code> is required for the <code>struct</code> while still being able to pass it around as <code>func(a_packed_packet_t p)</code>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md216"></a>
Comments</h1>
<h2><a class="anchor" id="autotoc_md217"></a>
Function comments</h2>
<p >In header files create a description for the methods or classes that looks like this (which is doxygen compatible). Describe what the function does for the user, not how it works or how it is implemented. Private function comments can contain some more implementation details. Use complete grammatical sentences starting with a capital and ending with a dot.</p>
<div class="fragment"><div class="line">/**</div>
<div class="line"> * Short description.</div>
<div class="line"> *</div>
<div class="line"> * Optional longer explanation.</div>
<div class="line"> *</div>
<div class="line"> * @param[in]     aParameter            Explanation.</div>
<div class="line"> * @param[out]    anotherParameter      Explanation.</div>
<div class="line"> * @param[in,out] exoticInOutParameter  Explanation.</div>
<div class="line"> * @return        Explanation.</div>
<div class="line"> */</div>
</div><!-- fragment --><p >In source files additional information can be given about particular implementation details. This will not end up in doxygen (a single <code>/*</code> rather than <code>/**</code> code block starter is sufficient).</p>
<div class="fragment"><div class="line">/*</div>
<div class="line"> * Optional longer explanation.</div>
<div class="line"> */</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md218"></a>
Struct comments</h2>
<p >Similar style as classes;</p>
<ul>
<li>Add a comment above the struct to explain the struct.</li>
<li>Add comments above fields to explain the fields.</li>
</ul>
<p >Comments will end up in doxygen at the right place with the following syntax:</p>
<div class="fragment"><div class="line">/**</div>
<div class="line"> * Result struct after configuring an ADC channel. Has all the info to put the sample values in context.</div>
<div class="line"> */</div>
<div class="line">struct __attribute__((packed)) adc_channel_config_result_t {</div>
<div class="line">    //! The AIN pin of this channel.</div>
<div class="line">    adc_pin_id_t pin;</div>
<div class="line"> </div>
<div class="line">    /**</div>
<div class="line">     * If the field requires more text,</div>
<div class="line">     * make it a multi line comment.</div>
<div class="line">     */</div>
<div class="line">     uint8_t complex;</div>
<div class="line">};</div>
</div><!-- fragment --><p >There are a couple of reasons to write the comments not at the same line of the code:</p>
<ul>
<li>The line length limitation is more easily maintained (we limit the number of columns to 120, see this doc).</li>
<li>The linter adjusts the alignment of all struct comments when a field name is extended. Hence, renaming spills over in whitespace changes on other lines.</li>
<li>Alignment across structs depends on the longest field name length per struct, hence it is different for each struct.</li>
</ul>
<p >These issues are prevented by writing the comments on separate lines.</p>
<h2><a class="anchor" id="autotoc_md219"></a>
General</h2>
<p >Within the function bodies themselves, abstain from comments unless absolutely necessary. If comments are required, write them on a line preceding the code. Do <b>not</b> write comments on the same line as the code.</p>
<div class="fragment"><div class="line">// Always write comments on a separate line.</div>
<div class="line">bool result = false;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md220"></a>
Get rid of TODOs</h2>
<p >Don't sprinkle the code with many TODOs, use them only when absolutely necessary.</p>
<h2><a class="anchor" id="autotoc_md221"></a>
Get rid of commented code</h2>
<p >If code is commented it should be deleted. If you want to preserve code for posterity find other means to do so.</p>
<h1><a class="anchor" id="autotoc_md222"></a>
CMake</h1>
<h2><a class="anchor" id="autotoc_md223"></a>
Auto generated files</h2>
<p >Always use the <code>@ONLY</code> option when using <code>configure_file(..)</code>. This increases grep-ability of the codebase and makes for clearer template files for bash scripts.</p>
<h2><a class="anchor" id="autotoc_md224"></a>
Config values</h2>
<p >Some config values are defined both in code and in config files. These are statically checked to be equal during compilation. For these variables, the config file variable name is leading and should be used where possible.</p>
<p >E.g. the memory locations of some firmware blobs:</p>
<p >The config defines the leading variable name. </p><div class="fragment"><div class="line">./config/nrf52840/CMakeBuild.config</div>
<div class="line"> </div>
<div class="line"># This setting is defined in nrf_dfu_types.h. Here we predefine it so it is available to the wider code base.</div>
<div class="line"># This is the mbr settings address for the nRF52840-QFAA.</div>
<div class="line">CS_BOOTLOADER_SETTINGS_ADDRESS=0xFF000</div>
</div><!-- fragment --><p >In other files, this name is used. </p><div class="fragment"><div class="line">./source/CMakeLists.txt</div>
<div class="line"> </div>
<div class="line">add_custom_target(read_bootloader_settings</div>
<div class="line">    COMMAND ${CMAKE_COMMAND} ${DEFAULT_TOOL_PARAM} &quot;-DINSTRUCTION=READ&quot; &quot;-DADDRESS=${BOOTLOADER_SETTINGS_ADDRESS}&quot; &quot;-DCOUNT=128&quot; -P ${DEFAULT_MODULES_PATH}/nrfjprog.cmake</div>
<div class="line">    COMMENT &quot;Read bootloader settings from remote target board&quot;</div>
<div class="line">    )</div>
</div><!-- fragment --><p >The relevant source file statically asserts the equality. </p><div class="fragment"><div class="line">./source/include/cfg/cs_MemoryLayout.h.in:</div>
<div class="line"> </div>
<div class="line">_Static_assert(</div>
<div class="line">        BOOTLOADER_SETTINGS_ADDRESS == @CS_BOOTLOADER_SETTINGS_ADDRESS@, &quot;Bootloader settings address mismatch&quot;);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
