<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: Behaviour</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_protocol_BEHAVIOUR.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="classBehaviour.html" title="Class to derrive behaviours from, centralizing common variables such as from and until times.">Behaviour</a> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Behaviours can be set and retrieved. The user can check the master hash to check if all behaviours are synchronized.</p>
<h1><a class="anchor" id="autotoc_md483"></a>
Table of contents</h1>
<ul>
<li>Commands</li>
<li>Packets</li>
</ul>
<h1><a class="anchor" id="autotoc_md484"></a>
Behaviour Commands</h1>
<ul>
<li>Add</li>
<li>Replace</li>
<li>Remove</li>
<li>Get</li>
<li>List</li>
</ul>
<h2><a class="anchor" id="autotoc_md485"></a>
Add behaviour</h2>
<p >Add a new behaviour to an empty index.</p>
<h3><a class="anchor" id="autotoc_md486"></a>
Add behaviour packet</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Behaviour   </td><td class="markdownTableBodyNone">Data   </td><td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone"><a class="el" href="classBehaviour.html" title="Class to derrive behaviours from, centralizing common variables such as from and until times.">Behaviour</a> to add.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md487"></a>
Result codes</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Explanation    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">NO_SPACE   </td><td class="markdownTableBodyNone">All behaviour slots have already been taken.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">BUSY   </td><td class="markdownTableBodyNone">The memory was too busy to respond.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SUCCESS   </td><td class="markdownTableBodyNone">There was a slot free, and memory wasn't busy - request executed. See return payload for details.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone">Other cases may happen in case of exception.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md488"></a>
Add behaviour result packet</h3>
<p >The result will always contain the most current master hash.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Index   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">The index at which the behaviour is stored, or 255 when not successful.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Hash   </td><td class="markdownTableBodyNone">Master hash   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">The master hash after handling the request.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md489"></a>
Replace Behaviour</h2>
<p >Replace a behaviour at given index by the given behaviour.</p>
<h3><a class="anchor" id="autotoc_md490"></a>
Replace behaviour packet</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Index   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Index of the behaviour to replace.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Behaviour   </td><td class="markdownTableBodyNone">Data   </td><td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone"><a class="el" href="classBehaviour.html" title="Class to derrive behaviours from, centralizing common variables such as from and until times.">Behaviour</a> to replace the current one at given index with.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md491"></a>
Result codes</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Explanation    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">WRONG_PARAMETER   </td><td class="markdownTableBodyNone">The index is out of range.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">BUSY   </td><td class="markdownTableBodyNone">The memory was too busy to respond.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SUCCESS   </td><td class="markdownTableBodyNone">The index is valid and memory could be queried. See return payload for details.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone">Other cases may happen in case of exception.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md492"></a>
Replace behaviour result packet</h3>
<p >The result will always contain the most current master hash.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Index   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">The index at which the behaviour was replaced.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Hash   </td><td class="markdownTableBodyNone">Master hash   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">The master hash after handling the request.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md493"></a>
Remove behaviour</h2>
<p >Remove the behaviour at given index.</p>
<h3><a class="anchor" id="autotoc_md494"></a>
Remove behaviour packet</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Index   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Index of the behaviour to remove.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md495"></a>
Result codes</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Explanation    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">WRONG_PARAMETER   </td><td class="markdownTableBodyNone">The index is out of range.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">BUSY   </td><td class="markdownTableBodyNone">The memory was too busy to respond.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SUCCESS   </td><td class="markdownTableBodyNone"><a class="el" href="classBehaviour.html" title="Class to derrive behaviours from, centralizing common variables such as from and until times.">Behaviour</a> at given index is removed, or was already empty.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone">Other cases may happen in case of exception.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md496"></a>
Remove behaviour result packet</h3>
<p >The result will always contain the most current master hash.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Index   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">The index from which the behaviour was removed.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Hash   </td><td class="markdownTableBodyNone">Master hash   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">The master hash after handling the request.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md497"></a>
Get behaviour</h2>
<p >Retrieve the behaviour at given index.</p>
<h3><a class="anchor" id="autotoc_md498"></a>
Get behaviour packet</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Index   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Index of the behaviour to obtain.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md499"></a>
Result codes</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Explanation    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">WRONG_PARAMETER   </td><td class="markdownTableBodyNone">The index is out of range.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">NOT_FOUND   </td><td class="markdownTableBodyNone">No behaviour was found at given index.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">BUSY   </td><td class="markdownTableBodyNone">The memory was too busy to respond.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SUCCESS   </td><td class="markdownTableBodyNone">The index is valid and memory could be queried. See return payload for details.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone">Other cases may happen in case of exception.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md500"></a>
Get behaviour result packet</h3>
<p >If the index is unoccupied, the result payload has length 0.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Index   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">The index of the requested behaviour.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Behaviour   </td><td class="markdownTableBodyNone">Data   </td><td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone">The behaviour that is stored at the given <code>Index</code>.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md501"></a>
Get behaviour indices</h2>
<p >Query which indices in the behaviour store are currently occupied.</p>
<h3><a class="anchor" id="autotoc_md502"></a>
Result codes</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Explanation    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">BUSY   </td><td class="markdownTableBodyNone">The memory was too busy to respond.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SUCCESS   </td><td class="markdownTableBodyNone">Memory could be queried. See return payload for details.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone">Other cases may happen in case of exception.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md503"></a>
Behaviour indices result packet</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Index with hash[]   </td><td class="markdownTableBodyNone">list   </td><td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone">List of all occupied indices, and their hashes.   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md504"></a>
Behaviour packets</h1>
<h3><a class="anchor" id="autotoc_md505"></a>
Behaviour payload</h3>
<p ><img src="../diagrams/behaviour-payload.png" alt="Behaviour payload" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8_t   </td><td class="markdownTableBodyNone">Type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone"><ol start="0">
<li>
Switch behaviour</li>
<li>
Twilight behaviour</li>
<li>
Smart timer</li>
</ol>
</td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8_t[]   </td><td class="markdownTableBodyNone">Data   </td><td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone">Type dependent   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md506"></a>
Switch behaviour</h3>
<p ><img src="../diagrams/switch-behaviour.png" alt="Switch behaviour" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Intensity   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Value from 0-100, both inclusive, indicating the desired intensity of the device (0 for 'off', 100 for 'fully on')    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">ProfileId   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">This behaviour belongs to the given Profile ID. (Currently unused)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Day of week bitmask   </td><td class="markdownTableBodyNone">Active days   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Selects which days of the week this behaviour is active    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Time of day   </td><td class="markdownTableBodyNone">From   </td><td class="markdownTableBodyNone">5   </td><td class="markdownTableBodyNone">The behaviour is active from, inclusive, this time of day.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Time of day   </td><td class="markdownTableBodyNone">Until   </td><td class="markdownTableBodyNone">5   </td><td class="markdownTableBodyNone">The behaviour is active until, exclusive, this time of day.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Presence description   </td><td class="markdownTableBodyNone">Presence   </td><td class="markdownTableBodyNone">13   </td><td class="markdownTableBodyNone">Description of the presence conditions that need to hold for this behaviour to be active.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md507"></a>
Twilight behaviour</h3>
<p ><img src="../diagrams/twilight-behaviour.png" alt="Twilight behaviour" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Intensity   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Value from 0-100, both inclusive, indicating the desired intensity of the device (0 for 'off', 100 for 'fully on')    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">ProfileId   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">This behaviour belongs to the given Profile ID. (Currently unused)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Day of week bitmask   </td><td class="markdownTableBodyNone">Active days   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Selects which days of the week this behaviour is active    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Time of day   </td><td class="markdownTableBodyNone">From   </td><td class="markdownTableBodyNone">5   </td><td class="markdownTableBodyNone">The behaviour is active from, inclusive, this time of day.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Time of day   </td><td class="markdownTableBodyNone">Until   </td><td class="markdownTableBodyNone">5   </td><td class="markdownTableBodyNone">The behaviour is active until, exclusive, this time of day.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md508"></a>
Smart timer</h3>
<p >A Smart timer consists of a switch behaviour and an exit condition. This can be used to ensure that for example, when a timer expires it will wait until the room is empty before switching off the device. (Essentially extending the original behaviour.)</p>
<p >At the 'Until'-time of the 'Core' behaviour, it is checked whether the behaviour is still active (i.e. its presence condition is still fullfilled). If that is the case, a temporary extension for the behaviour is created which is identical to the Core behaviour with the Presence condition replaced by the Extension Presence and the Until time replaced by the Extension Until time. This temporary rule will be destroyed after the Extension Until time expires. If the extension end condition timeout is set to 0, the temporary behaviour will be destroyed as soon as the presencecondition is no longer met.</p>
<p ><img src="../diagrams/smart-timer.png" alt="Smart timer" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Switch behaviour   </td><td class="markdownTableBodyNone">Core behaviour   </td><td class="markdownTableBodyNone">26   </td><td class="markdownTableBodyNone">The core behaviour is interpreted identical to switch behaviour.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">End condition   </td><td class="markdownTableBodyNone">Extension end condition   </td><td class="markdownTableBodyNone">17   </td><td class="markdownTableBodyNone">Describes the conditions that determine when this extension will be removed.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md509"></a>
Behaviour end condition</h3>
<p ><img src="../diagrams/behaviour-end-condition.png" alt="End Condition" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Presence description   </td><td class="markdownTableBodyNone">Extension presence   </td><td class="markdownTableBodyNone">13   </td><td class="markdownTableBodyNone">Description of the presence conditions that the Extension behaviour will use.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md510"></a>
Behaviour master hash</h3>
<p >The <code><a class="el" href="classBehaviourStore.html" title="Keeps track of the behaviours that are active on this crownstone.">BehaviourStore</a></code> can generate a hash that can be used to verify if an application is up to date. The data that is hashed is as in the following table. The hashing algorithm used is <a href="https://en.wikipedia.org/wiki/Fletcher%27s_checksum">Fletcher32</a>. As this algorithm is based on 16-bit integer array as input each entry in the table below is padded with 0x00 at the end if its length is uneven.</p>
<p >Only indices with non empty behaviours are used to calculate the master hash.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Index0   </td><td class="markdownTableBodyNone">1 (padded with 0x00)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Behaviour   </td><td class="markdownTableBodyNone">Behaviour0   </td><td class="markdownTableBodyNone">size depends on the type of payload    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Index1   </td><td class="markdownTableBodyNone">1 (padded with 0x00)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Behaviour   </td><td class="markdownTableBodyNone">Behaviour1   </td><td class="markdownTableBodyNone">size depends on the type of payload    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone">...   </td><td class="markdownTableBodyNone">...    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">IndexLast   </td><td class="markdownTableBodyNone">1 (padded with 0x00)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Behaviour   </td><td class="markdownTableBodyNone">BehaviourLast   </td><td class="markdownTableBodyNone">size depends on the type of payload   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md511"></a>
Index and behaviour hash</h3>
<p >For each behaviour individually, a hash can be calculated as well, similar to the master hash.</p>
<p ><img src="../diagrams/behaviour-index-and-behaviour-hash.png" alt="Index and behaviour hash" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">index   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Index of an occupied behaviour.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint32   </td><td class="markdownTableBodyNone"><a class="el" href="classBehaviour.html" title="Class to derrive behaviours from, centralizing common variables such as from and until times.">Behaviour</a> hash   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">The hash of the behaviour at this index. Generated by calculating the <a href="https://en.wikipedia.org/wiki/Fletcher%27s_checksum">Fletcher32</a> hash of the behaviour data, padded with zeroes if necessary.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md512"></a>
Time difference</h3>
<p ><img src="../diagrams/time-difference.png" alt="Time difference" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">int32   </td><td class="markdownTableBodyNone"><a class="el" href="classTime.html" title="Author: Crownstone Team Copyright: Crownstone (https://crownstone.rocks) Date: Sep 24,...">Time</a> payload   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Signed difference in seconds since a known-from-context moment in time (future - past &gt;= 0).   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md513"></a>
Time of day</h3>
<p ><img src="../diagrams/time-of-day.png" alt="Time of day" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Base time   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone"><ol start="0">
<li>
Midnight </li>
<li>
Sunrise </li>
<li>
Sunset</li>
</ol>
</td></tr>
</table>
<p>Time difference | Offset | 4 |</p>
<h3><a class="anchor" id="autotoc_md514"></a>
Day of week bitmask</h3>
<p ><img src="../diagrams/day-of-week-bitmask.png" alt="Day of week" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Bitmask   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">0: sunday - 6: saturday. 7: must be 0.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md515"></a>
Presence description</h3>
<p >Given that for each room it is known if there are users present in that room or not, a Presence Description evaluates to 'true' or 'false'. It can be used to implement behaviours that take current presence into account.</p>
<p ><img src="../diagrams/presence-description.png" alt="Presence description" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone"><ol start="0">
<li>
Vacuously true condition</li>
<li>
Anyone in any of the rooms</li>
<li>
Noone in any of the rooms</li>
<li>
Anyone anywhere in sphere</li>
<li>
Noone anywhere in sphere</li>
</ol>
</td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint64   </td><td class="markdownTableBodyNone">Active rooms mask   </td><td class="markdownTableBodyNone">8   </td><td class="markdownTableBodyNone">Room with id <code>i</code> corresponds to bit <code>i</code> in this mask.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint32_t   </td><td class="markdownTableBodyNone">Timeout   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Whenever a presence description is satisfied (evaluates to true), it shall evaluate to true until this time out expires. Use 0 to ignore. Units: seconds.   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md516"></a>
Firmware design internals</h1>
<p >In the diagram below the event flow concerning Behaviours and Twilights is depicted. Double arrows (annotated) indicate which <code>event</code>'s are received and handled by the node pointed to, red/dashed objects indicate not-yet implemented features, aggregation arrows indicate object ownership as in the sense of UML and lines indicate connection to physical domain.</p>
<p >Main essence of the design is that there are multiple ways that a use can operate on the same switch. Each of these has their own semantics, and therefore a piece of software needs to aggregate between these input channels in order to decide what actually will have to happen. This is the job of the <a class="el" href="classSwitchAggregator.html" title="Author: Crownstone Team Copyright: Crownstone (https://crownstone.rocks) Date: Sep 26,...">SwitchAggregator</a>. The aggregator has a SystemSwitch object which takes care of the safety and integrity of the physical device by monitoring error states and for example blocking access in case of overheating. Any commands passed down from SystemSwitch onto HwSwitch will be pushed into the driver. This last layer allows to abstract away from any hardware specifics and later could be part of the mock-up surface.</p>
<p >Storing behaviours and Twilights will require additional logic in order to ensure synchronisation across different devices/phones. All communication from and to host devices regarding Behaviours and Twilights is extracted into a <a class="el" href="classStore.html" title="A storage utility for objects of type Rec.">Store</a> object, that takes care of this matter. The corresponding handler object can access the store to query the active Behaviours/Twilights whenever necessary through a static reference.</p>
<p ><img src="../diagrams/behaviourhandler-overview.svg" alt="Behaviour handler overview" style="pointer-events: none;" class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
