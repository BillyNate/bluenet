<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: Asset filtering</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_protocol_ASSET_FILTERING.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Asset filtering </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This page describes protocol for the asset filtering component.</p>
<h1><a class="anchor" id="autotoc_md636"></a>
Table of contents</h1>
<p >Versionneighbouring</p><ul>
<li>Protocol version</li>
</ul>
<p >Common</p><ul>
<li>Filter ID</li>
<li>Asset ID</li>
<li>Master version</li>
<li>Master CRC</li>
</ul>
<p >Commands packets</p><ul>
<li>Get filter summaries</li>
<li>Upload filter</li>
<li>Remove filter</li>
<li>Commit filter changes</li>
</ul>
<p >Filter summary packets</p><ul>
<li>Filter summary</li>
</ul>
<p >Filter packets</p><ul>
<li>Filter packet</li>
<li>Filter metadata</li>
<li>Filter type</li>
<li>Filter flags</li>
</ul>
<p >Filter data packets</p><ul>
<li>Exact match</li>
</ul>
<p >Filter input and output packets</p><ul>
<li>Input description</li>
<li>Output description</li>
<li>Output format</li>
</ul>
<p >Advertisement data selection</p><ul>
<li>BLE advertisement</li>
<li>Advertisement subdata</li>
<li>Advertisement subdata type</li>
<li>Masked AD data</li>
</ul>
<h1><a class="anchor" id="autotoc_md637"></a>
Protocol version</h1>
<h2><a class="anchor" id="autotoc_md638"></a>
Asset filter store protocol version</h2>
<p >All asset filter store commands are prefixed with a protocol version. This version will be incremented when making breaking changes to the protocol.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">Current version.   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md639"></a>
Common packets</h1>
<h2><a class="anchor" id="autotoc_md640"></a>
Filter ID</h2>
<p >A <code>uint8</code> that identifies the filter, these IDs are freely chosen by the user. There is a maximum number of filters on the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a>, which is currently set at 8.</p>
<h2><a class="anchor" id="autotoc_md641"></a>
Asset ID</h2>
<p >A <b>3 byte</b> identifier that is used to differentiate between assets. It is determined by calculating the CRC-32 of a part of the asset advertisement. Which part is determined by the input format of the output description. The 3 least significant bytes of the calculated CRC-32 are the asset ID.</p>
<h2><a class="anchor" id="autotoc_md642"></a>
Master version</h2>
<p >A <code>uint16</code> that is used to determine which <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> has a newer set of filters. The <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> with the newest version, will upload its filters to neighbouring Crownstones. The master version is a uint16 value and overflows to 1, because 0 has a special meaning:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">Unknown or unset version. Always older than non-zero versions.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Other   </td><td class="markdownTableBodyNone">Version <code>a</code> is newer than <code>b</code> when <code>a &gt; b + n</code> when <code>1 &lt;= n &lt; 2^(16-1)</code>. Note that <code>b + n</code> also overflows to 1.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md643"></a>
Master CRC</h2>
<p >A <code>uint32</code> that is the CRC-32 of all filter IDs and filter CRCs. For <code>N</code> filters, calculate the CRC-32 of the sorted list: <code>[ID_1, CRC_1, ID_2, CRC_2, .... , ID_N, CRC_N]</code>. Where, <code>ID_1</code> and <code>CRC_1</code> are the filter ID and CRC of the filter with the lowest filter ID.</p>
<hr  />
<h1><a class="anchor" id="autotoc_md644"></a>
Control commands</h1>
<h2><a class="anchor" id="autotoc_md645"></a>
Get filter summaries</h2>
<p >Get a summary of all filters currently on the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> and some extra metadata.</p>
<h3><a class="anchor" id="autotoc_md646"></a>
Get filter summaries result packet</h3>
<p ><img src="../diagrams/asset_filter_summaries_packet.png" alt="Filter summaries packet" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Protocol version   </td><td class="markdownTableBodyNone">Protocol   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Protocol version of the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a>, commands should use the same protocol.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint16   </td><td class="markdownTableBodyNone">Master version   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">Current master version on the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a>.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint32   </td><td class="markdownTableBodyNone">Master CRC   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Current master CRC on the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a>.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint16   </td><td class="markdownTableBodyNone">Free space   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">The number of free bytes for filter data. Note that each filter will have overhead.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Filter summary[]   </td><td class="markdownTableBodyNone">Summaries   </td><td class="markdownTableBodyNone">N * 4   </td><td class="markdownTableBodyNone">Summaries of all filters currently on the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a>.   </td></tr>
</table>
<p >Result codes:</p><ul>
<li><code>SUCCESS</code>: Success.</li>
<li><code>BUSY</code>: There are uncommitted filter changes. Commit or wait for timeout.</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md647"></a>
Upload filter</h2>
<p >Command to upload a filter in chunks. All chunks will be merged by the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a>. If a previously committed filter with the same filter ID is already present on the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a>, it will be removed prior to handling the chunk.</p>
<h3><a class="anchor" id="autotoc_md648"></a>
Upload filter packet</h3>
<p >class <img src="../diagrams/asset_filter_upload_packet.png" alt="Upload filter packet" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Protocol version   </td><td class="markdownTableBodyNone">Protocol   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Protocol of this packet.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Filter ID   </td><td class="markdownTableBodyNone">Filter ID   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Which filter index to upload to.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint16   </td><td class="markdownTableBodyNone">Chunk start index   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">Offset in bytes of this chunk.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint16   </td><td class="markdownTableBodyNone">Total size   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">Total size of the filter data.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint16   </td><td class="markdownTableBodyNone">Chunk size   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">Size of this chunk.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Chunk data   </td><td class="markdownTableBodyNone">Chunk size   </td><td class="markdownTableBodyNone">Chunk of a filter packet, starting at byte <code>Chunk start index</code> and <code>Chunk size</code> bytes in total.   </td></tr>
</table>
<p >Result codes:</p><ul>
<li><code>SUCCESS</code>: Chunk has been stored.</li>
<li><code>INVALID_MESSAGE</code>: Chunk would overflow total size of the filter.</li>
<li><code>WRONG_STATE</code>: Total size changed between upload commands. All uploade chunks for this filter ID have been removed.</li>
<li><code>NO_SPACE</code>: There is not enough space for the given total filter size.</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md649"></a>
Remove filter</h2>
<p >Removes the filter with given filter ID.</p>
<h3><a class="anchor" id="autotoc_md650"></a>
Remove filter packet</h3>
<p ><img src="../diagrams/asset_filter_remove_packet.png" alt="Remove filter packet" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Protocol version   </td><td class="markdownTableBodyNone">Protocol   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Protocol of this packet.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Filter ID   </td><td class="markdownTableBodyNone">Filter ID   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">ID of the filter to remove.   </td></tr>
</table>
<p >Result codes:</p><ul>
<li><code>SUCCESS</code>: Filter has been removed.</li>
<li><code>SUCCESS_NO_CHANGE</code>: Filter was already removed.</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md651"></a>
Commit filter changes</h2>
<p >Commit the changes that were made.</p>
<h3><a class="anchor" id="autotoc_md652"></a>
Commit filter packet</h3>
<p ><img src="../diagrams/asset_filter_commit_packet.png" alt="Commit filter packet" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Protocol version   </td><td class="markdownTableBodyNone">Protocol   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Protocol of this packet.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint16   </td><td class="markdownTableBodyNone">Master version   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">The new master version value that will be set after successful commit.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint32   </td><td class="markdownTableBodyNone">Master CRC   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Master CRC of the new filter set.   </td></tr>
</table>
<p >Result codes:</p><ul>
<li><code>SUCCESS</code>: All filters passed the consistency checks and the master CRC matches. The master version is updated to the given value.</li>
<li><code>MISMATCH</code>: The master CRC did not match.</li>
<li><code>WRONG_STATE</code>: Some filters failed consistency checks, and have been removed.</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md653"></a>
Filter summary packets</h1>
<h2><a class="anchor" id="autotoc_md654"></a>
Filter summary</h2>
<p >A summary of a filter.</p>
<p ><img src="../diagrams/asset_filter_summary_packet.png" alt="Filter summary packet" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Filter ID   </td><td class="markdownTableBodyNone">Filter ID   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">The ID of this filter.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint32   </td><td class="markdownTableBodyNone">Filter CRC   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">The CRC-32 of the filter.   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md655"></a>
Filter packets</h1>
<h2><a class="anchor" id="autotoc_md656"></a>
Filter packet</h2>
<p ><img src="../diagrams/asset_filter_packet.png" alt="Filter packet" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Filter metadata   </td><td class="markdownTableBodyNone">Metadata   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Metadata determining how the filter behaves.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Filter data   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Byte representation of the filter, format depends on the filter type.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md657"></a>
Filter metadata</h2>
<p ><img src="../diagrams/asset_filter_metadata_packet.png" alt="Filter metadata packet" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Filter type   </td><td class="markdownTableBodyNone">Filter type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Filter protocol of this filter. Determines the filter data format.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Filter flags   </td><td class="markdownTableBodyNone">Flags   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Flags bitmask.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Profile ID   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Entries that pass this filter will be associated with this profile ID. Set to 255 for no profile ID.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Filter input description   </td><td class="markdownTableBodyNone">Input   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Determines what part of the asset advertisement data to use as input for the filter.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Filter output description   </td><td class="markdownTableBodyNone">Output   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Determines the output of the filter of asset advertisements that pass it.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md658"></a>
Filter type</h2>
<p >A <code>uint8</code> defining the format and implementation of the filter datastructure.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">Cuckoo filter   </td><td class="markdownTableBodyNone">Good for many items (each item is compressed to 2B), but has more false positives. Filter data is interpreted as <a href="./CUCKOO_FILTER.md#cuckoo-filter-data">cuckoo filter data</a>.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Exact match filter   </td><td class="markdownTableBodyNone">No, or few, false positives, but can generally hold fewer items. Filter data is interpreted as exact match filter.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md659"></a>
Filter flags</h2>
<p >A <code>uint8</code> with flags.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Bit   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">Exclude   </td><td class="markdownTableBodyNone">If set, the asset advertisements that pass this filter will be ignored, even if it passes other filters. Note: this does not mean that assets that do not pass this filter result in an output.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1-7   </td><td class="markdownTableBodyNone">Reserved   </td><td class="markdownTableBodyNone">Reserved for future usage, must be 0 for now.   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md660"></a>
Filter data packets</h1>
<h2><a class="anchor" id="autotoc_md661"></a>
Exact match filter data</h2>
<p ><img src="../diagrams/exact_match_filter_data.png" alt="Exact match filter data" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Item count   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Number of items in the filter. Must be larger than 0.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Item size   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Size of each item in bytes. Must be larger than 0.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Items   </td><td class="markdownTableBodyNone">Count * size   </td><td class="markdownTableBodyNone">The item array. The items must be ordered (such that items[i] &lt;= items[i+1]).   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md662"></a>
Filter input and output packets</h1>
<h2><a class="anchor" id="autotoc_md663"></a>
Filter input description</h2>
<p >The input description defines what part of the asset advertisement is matched against the filter entries, in order to determine wether or not the advertisement passes the filter.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Advertisement subdata   </td><td class="markdownTableBodyNone">Format   </td><td class="markdownTableBodyNone">What part of the asset advertisment data is used to filter on.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md664"></a>
Filter output description</h2>
<p >When an asset advertisement passed a filter, there will be an output. This output may use parts of the advertisement data.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Output format   </td><td class="markdownTableBodyNone">Output format   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Determines how the output is formatted.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Input format data   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Describes which part of the advertisment is used to construct the output. Type and length of this field depends on output format.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md665"></a>
Filter output format</h2>
<p >This output format is a <code>uint8</code> that:</p><ul>
<li>Determines the result of an asset advertisement that passes a filter.</li>
<li>Determines how the asset ID is determined.</li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Input format type   </th><th class="markdownTableHeadNone">Output description type    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">Mac   </td><td class="markdownTableBodyNone">None   </td><td class="markdownTableBodyNone">The full MAC address will be reported, see <a href="MESH_PROTOCOL.md#asset-mac-report">mesh</a> and <a href="UART_PROTOCOL.md#asset-mac-report">UART</a>.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Asset ID   </td><td class="markdownTableBodyNone">Advertisement subdata   </td><td class="markdownTableBodyNone">The asset ID will be reported, see <a href="MESH_PROTOCOL.md#asset-id-report">mesh</a> and <a href="UART_PROTOCOL.md#asset-id-report">UART</a>.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">None   </td><td class="markdownTableBodyNone">None   </td><td class="markdownTableBodyNone">No mesh output is generated. Firmware will still update its internal presence information for the asset.   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md666"></a>
Advertisement data selection.</h1>
<p >Before explaining the advertisement selection, let's first have a look at the data in an advertisement.</p>
<h2><a class="anchor" id="autotoc_md667"></a>
BLE advertisement</h2>
<p >A BLE advertisement has the following data:</p>
<p ><img src="../diagrams/ble_adv_packet.png" alt="BLE advertisement" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Preamble   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Always the same value (10101010b).    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint32   </td><td class="markdownTableBodyNone">Access address   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Always the same value (0x8E89BED6)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">Contains type of advertisement, length, etc.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">MAC address   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">The MAC address.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AD field[]   </td><td class="markdownTableBodyNone">AD fields   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">A list of AD fields.   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md668"></a>
AD field</h3>
<p ><img src="../diagrams/ble_adv_data_packet.png" alt="BLE advertisement data field" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Length   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Length of this AD field.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Type of AD data, see <em>Generic Access Profile</em> in the BLE specifications.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Data   </td><td class="markdownTableBodyNone">Length - 1   </td><td class="markdownTableBodyNone">The data of this AD field.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md669"></a>
Advertisement subdata</h2>
<p >This defines a dataformat/selection of data of an advertisement.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Advertisement subdata type   </td><td class="markdownTableBodyNone">Type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">See table below.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Payload   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Depends on <em>type</em>, see table below.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md670"></a>
Advertisement subdata type</h2>
<p >The advertisement subdata type field can have the following values.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Payload type   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">Mac   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">The (full) MAC address is selected.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">AD type   </td><td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">The data of the AD field with given AD type is selected.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">Masked AD data   </td><td class="markdownTableBodyNone">Masked AD data   </td><td class="markdownTableBodyNone">Same as <em>AD type</em>, but the data is now masked by a byte wise mask.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md671"></a>
Masked AD data</h2>
<p >Adds a mask that defines which part of an AD field is relevant.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">AD type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">The data of the AD field with given AD type is selected.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint32   </td><td class="markdownTableBodyNone">Mask   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">If the Nth bit is set, the Nth byte of the data is selected. All selected bytes are concatenated.   </td></tr>
</table>
<hr  />
<h1><a class="anchor" id="autotoc_md672"></a>
Internals</h1>
<p >Explanation of the asset filter store implementation.</p>
<h2><a class="anchor" id="autotoc_md673"></a>
Modification in progress</h2>
<p >When a crownstone reboots it loads any filters stored on flash into RAM, and check whether the filters are valid.</p>
<p >If an upload or remove command is received, it will change its run-time filters accordingly and set a flag <code>filterModificationInProgress</code> to true. During modifications the advertisement handler will be paused to prevent inconsistent behaviour. The progress flag stays active until a succesfully executed commit command or a timeout occurs.</p>
<h2><a class="anchor" id="autotoc_md674"></a>
Commit</h2>
<p >A commit filter changes command signifies the end of a sequence of changes. When this is received the firmware will perform several consistency checks:</p><ul>
<li>CRC values are recomputed where necessary</li>
<li>Filters are checked for size consistency (e.g. allocated space for a tracking filter must match the cuckoo filter size definition)</li>
</ul>
<p >Any malformed filters may immediately be deallocated to save resources and prevent firmware crashes. When return value is not <code>SUCCESS</code>, query the status with a get filter summaries command for more information. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
