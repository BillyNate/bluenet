<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: Bootloader</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_BOOTLOADER.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Bootloader </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >There are two possible bootloaders that can be used. The first one is the so-called "secure bootloader" and is part of the Nordic SDK. The other one is the "mesh bootloader" and is part of the <a class="el" href="classMesh.html" title="Author: Crownstone Team Copyright: Crownstone (https://crownstone.rocks) Date: 12 Apr....">Mesh</a> SDK.</p>
<h1><a class="anchor" id="autotoc_md33"></a>
Secure bootloader</h1>
<p >The secure bootloader code in this repository is based on the <code>secure_bootloader/pca10040_ble</code> example in SDK 15.3.</p>
<p >You can find the information at the <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fcom.nordic.infocenter.sdk5.v15.3.0%2Flib_bootloader.html">Infocenter - Bootloader and DFU modules</a>. For dual bank see <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fcom.nordic.infocenter.sdk5.v15.3.0%2Flib_bootloader_dfu_banks.html">Infocenter - Bootloader and DFU modules - Device Firmware Update process</a>.</p>
<h2><a class="anchor" id="autotoc_md34"></a>
Installation</h2>
<p >The code for the bootloader is already there if you have downloaded the Nordic SDK. In the <code>CMakeList</code> file in the bootloader directory you see that the main file is set to <code>bootloader/main.c</code>. The <code><a class="el" href="cs__Boards_8h_source.html">cs_Boards.h</a></code> file is included so the right pins for serial are used. Including the logging functionalities by Nordic increases the binary size of the bootloader a lot. For release, make sure debugging output over serial is disabled.</p>
<p >A prerequisite to building the bootloader is a compiled encryption library (<code>micro-eec</code>):</p>
<p >Set the compiler (again, sorry!): </p><pre class="fragment">xdg-open ${NRF5_DIR}/components/toolchain/gcc/Makefile.posix
</pre><p> Build the lib: </p><pre class="fragment">${NRF5_DIR}/external/micro-ecc/build_all.sh
</pre><p> If the script is not executable, set its exec bit: </p><pre class="fragment">chmod u+x ${NRF5_DIR}/external/micro-ecc/build_all.sh
</pre><p> If it contains windows line-endings, remove them (<a href="https://stackoverflow.com/questions/11680815/removing-windows-newlines-on-linux-sed-vs-awk">stackoverflow will do</a>). Bug report filed <a href="https://devzone.nordicsemi.com/f/nordic-q-a/47429/bug-windows-line-ending-characters">at Nordic</a>.</p>
<p >Read more on the crypto backend at the <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.sdk5.v15.3.0/lib_crypto_backend_micro_ecc.html">Infocenter</a>.</p>
<p >To flash the bootloader to the device, use instructions from the <a class="el" href="md_docs_INSTALL.html">INSTALL</a> document. </p><pre class="fragment">./bluenet.sh -buB -t default
</pre><p> Note. If you set general breakpoints like <code>b main</code>, note that <code>gdb</code> will set the breakpoint both in the main of the bootloader and that of the firmware. </p><pre class="fragment">./bluenet.sh -dB -t default
</pre><p> It has no way to distinguish them. If you debug the firmware, <code>gdb</code> will start at the application address and breakpoints in the bootloader are skipped. </p><pre class="fragment">./bluenet.sh -dF -t default
</pre><p> To debug use the option <code>CS_SERIAL_NRF_LOG_ENABLED</code>. Set to <code>1</code> it will use <code>RTT</code>. Set to <code>2</code> it will use <code>UART</code>.</p>
<h2><a class="anchor" id="autotoc_md35"></a>
Start address and bootloader size</h2>
<p >The start address and size of the bootloader are defined in the linker script <code>secure_bootloader_gcc_nrf52.ld</code>. It is based on the script with the same name in <code>examples/dfu/secure_bootloader/pca10040_ble/armgcc</code>).</p>
<div class="fragment"><div class="line">FLASH (rx) : ORIGIN = 0x76000, LENGTH = 0x8000</div>
</div><!-- fragment --><p >When the device boots, it will look at <code>MBR_BOOTLOADER_ADDR</code> or <code>UICR.BOOTLOADERADDR</code> (<code>UICR.NRFFW[1]</code>, or <code>0x10001014</code>) for the start address of the bootloader. The size of the bootloader is fixed for the lifetime of the device. This is because the location (<code>MBR_BOOTLOADER_ADDR</code>) that stores the start address of the bootloader is not (safely) updateable.</p>
<p >If you enable debugging, you will need more space for the bootloader. You will get an overflow error at link time if there has not been enough space reserved.</p>
<div class="fragment"><div class="line">FLASH (rx) : ORIGIN = 0x71000, LENGTH = 0xd000</div>
</div><!-- fragment --><p >There are currently actually <b>two</b> locations where you have to define the start of the bootloader.</p>
<ol type="1">
<li>The <a href="../source/bootloader/secure_bootloader_gcc_nrf52.ld">secure_bootloader_gcc_nrf52.ld</a> script in the <code>bootloader</code> directory (see above).</li>
<li>The <code>CMakeBuild.config</code> file for the target you are building for. The default comes from <a href="../source/conf/cmake/CMakeBuild.config.default">CMakeBuild.config.default</a>.</li>
</ol>
<p >To allow for the additional space for debugging, starting at 0x71000 up to (almost!) the end of FLASH should be sufficient (adds up to <code>0x7E000</code>). Note, it's not up to <code>0x7FFFF</code>.</p>
<div class="fragment"><div class="line">BOOTLOADER_START_ADDRESS=0x00071000</div>
<div class="line">BOOTLOADER_LENGTH=0xD000</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md36"></a>
Challenge</h2>
<p >The devices in the field have an older bootloader. They need to be upgraded to the new bootloader which uses more space.</p>
<ul>
<li>A delicate upgrade process is required to update the current bootloader to the new bigger bootloader. This needs to be done in such a way that the chance of bricking a device in the field is neglectable. The process is stipulated at <a href="https://devzone.nordicsemi.com/f/nordic-q-a/18199/dfu---updating-from-legacy-sdk-v11-0-0-bootloader-to-secure-sdk-v12-x-0-bootloader">this forum post</a>.</li>
<li>Diligently optimize for size and memory of the bootloader. For example, enable link time optimization and analyse other ways to decrease the footprint of the bootloader.</li>
<li>Implement a secure setup procedure. Currently the setup is done by reducing the TX power such that someone eavesdropping needs to be physically close. However, there are software implementations that allow for 1) a secure key exchange to prevent eavesdropping and 2) authentication to prevent a MITM attack. This will improve the experience of the user, because there is no need to be physically close to the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> to configure it (or reconfigure it after an update).</li>
</ul>
<h1><a class="anchor" id="autotoc_md37"></a>
Mesh bootloader</h1>
<p >The mesh bootloader can be compiled by setting <code>BUILD_MESH_BOOTLOADER</code>. The documentation can be found in the <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.meshsdk.v3.1.0/md_doc_libraries_dfu_dfu_protocol.html">Infocenter - SDK - nRF5 SDK for Mesh 3.1.0 - Libraries - Mesh DFU Protocol</a> and subsections like <a href="https://infocenter.nordicsemi.com/topic/com.nordic.infocenter.meshsdk.v3.1.0/md_doc_libraries_dfu_dfu_quick_start.html">Configuring DFU over Mesh</a>. This uses the proprietary OpenMesh protocol under the hood (not the Bluetooth <a class="el" href="classMesh.html" title="Author: Crownstone Team Copyright: Crownstone (https://crownstone.rocks) Date: 12 Apr....">Mesh</a>). Moreover, you'll need one of the devices hooked up over a serial connection. Only then an update can be propagated over the mesh.</p>
<h2><a class="anchor" id="autotoc_md38"></a>
Challenge</h2>
<p >This challenge should only be tackled when the DFU process directly from a phone is working perfectly.</p>
<ul>
<li>Implement device firmware updates over the mesh. This makes use of a hub that has a USB dongle (<a href="https://shop.crownstone.rocks/products/crownstone-usb-dongle">link</a>). From this hub firmware updates can be propagated to nearby Crownstones. However, those Crownstones can further propagate their firmware updates if they will make use of the mesh. To implement this properly it might be necessary to modularize the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> software itself.</li>
</ul>
<p >This will require a hub and further in-depth studying of how to break up the software on the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a>. An analysis on how large the binaries are a very strong prerequisite. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
