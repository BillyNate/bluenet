<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: Memory</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_MEMORY.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Memory </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Information and decisions with respect to memory on the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> (both flash and ram).</p>
<p >To manage flash, bluenet makes use of the persistent storage manager (<code>fstorage</code> and <code>fds</code>) from the Nordic SDK.</p>
<h1><a class="anchor" id="autotoc_md355"></a>
Memory layout on the nRF52832</h1>
<p >The nRF52832 QFAA variant has 512 kB flash and 64 kB RAM. An individual page is 4 kB (<code>0x1000</code> in hex), hence there is space for 128 pages.</p>
<p >See the <a href="https://github.com/crownstone/bluenet/blob/master/source/conf/cmake/CMakeBuild.config.default">default config file</a>, the <a href="https://github.com/crownstone/bluenet/blob/master/config/default/CMakeBuild.config">default target file</a>, and the <a href="https://github.com/crownstone/bluenet/blob/master/source/include/third/nrf/generic_gcc_nrf52.ld">bluenet linker file</a>.</p>
<h2><a class="anchor" id="autotoc_md356"></a>
Flash</h2>
<p >The global layout of the flash memory is shown below for the nRF52832:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Start address   </th><th class="markdownTableHeadCenter">What   </th><th class="markdownTableHeadRight">Nr of pages   </th><th class="markdownTableHeadLeft">Config    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x00000000   </td><td class="markdownTableBodyCenter">MBR   </td><td class="markdownTableBodyRight">1   </td><td class="markdownTableBodyLeft">fixed    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x00001000   </td><td class="markdownTableBodyCenter">SD   </td><td class="markdownTableBodyRight">37   </td><td class="markdownTableBodyLeft">location: fixed <br  />
 size: implicit    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x00026000   </td><td class="markdownTableBodyCenter">App / Bluenet   </td><td class="markdownTableBodyRight">54   </td><td class="markdownTableBodyLeft">APPLICATION_START_ADDRESS<br  />
 implicit    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0005C000   </td><td class="markdownTableBodyCenter">Free   </td><td class="markdownTableBodyRight">13   </td><td class="markdownTableBodyLeft">implicit    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x00069000   </td><td class="markdownTableBodyCenter"><a class="el" href="classMicroapp.html" title="Class that enables the feature to run microapps on the firmware.">Microapp</a>   </td><td class="markdownTableBodyRight">4   </td><td class="markdownTableBodyLeft">FLASH_MICROAPP_BASE <br  />
 FLASH_MICROAPP_PAGES    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0006D000   </td><td class="markdownTableBodyCenter">P2P DFU   </td><td class="markdownTableBodyRight">1   </td><td class="markdownTableBodyLeft">location: implicit<br  />
 size: fixed    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0006E000   </td><td class="markdownTableBodyCenter">Reserved for FDS expansion   </td><td class="markdownTableBodyRight">4   </td><td class="markdownTableBodyLeft">location: implicit <br  />
 CS_FDS_VIRTUAL_PAGES_RESERVED_BEFORE    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x00072000   </td><td class="markdownTableBodyCenter">FDS   </td><td class="markdownTableBodyRight">4   </td><td class="markdownTableBodyLeft">location: implicit <br  />
 CS_FDS_VIRTUAL_PAGES    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x00076000   </td><td class="markdownTableBodyCenter">Bootloader   </td><td class="markdownTableBodyRight">7   </td><td class="markdownTableBodyLeft">BOOTLOADER_START_ADDRESS <br  />
 BOOTLOADER_LENGTH    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0007D000   </td><td class="markdownTableBodyCenter">Reserved for bootloader expansion   </td><td class="markdownTableBodyRight">1   </td><td class="markdownTableBodyLeft">location: implicit<br  />
 size: fixed    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0007E000   </td><td class="markdownTableBodyCenter">MBR settings   </td><td class="markdownTableBodyRight">1   </td><td class="markdownTableBodyLeft">CS_MBR_PARAMS_PAGE_ADDRESS <br  />
 size: fixed    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0007F000   </td><td class="markdownTableBodyCenter">Bootloader settings   </td><td class="markdownTableBodyRight">1   </td><td class="markdownTableBodyLeft">CS_BOOTLOADER_SETTINGS_ADDRESS <br  />
 size: fixed   </td></tr>
</table>
<p>| | <b>Total</b> | 128</p>
<p >The maximum size of the app is available as <code>APPLICATION_MAX_LENGTH</code>. For 54 + 13 pages this amounts to <code>(54 + 13) * 0x1000 = 0x43000</code>. This is about 256 kB. For a dual bank bootloader the firmware should than be 132 kB max so the old firmware can exist temporarily alongside the new firmware. This has not been achievable for us since a while, so no dual bank setup is in use. The build will fail if the app binary will go beyond the address <code>FLASH_MICROAPP_BASE</code> (<code>0x69000</code>).</p>
<h2><a class="anchor" id="autotoc_md357"></a>
RAM</h2>
<p >The layout for RAM memory is shown below for the nRF52832:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Start address   </th><th class="markdownTableHeadCenter">What   </th><th class="markdownTableHeadRight">Size   </th><th class="markdownTableHeadRight">Size   </th><th class="markdownTableHeadRight">Size (kB)    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x20000000   </td><td class="markdownTableBodyCenter">SD   </td><td class="markdownTableBodyRight">0x2A00   </td><td class="markdownTableBodyRight">10752   </td><td class="markdownTableBodyRight">10.5    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x20002A00   </td><td class="markdownTableBodyCenter">App heap and stack   </td><td class="markdownTableBodyRight">0xCD00   </td><td class="markdownTableBodyRight">52480   </td><td class="markdownTableBodyRight">51.25    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x2000F700   </td><td class="markdownTableBodyCenter"><a class="el" href="classMicroapp.html" title="Class that enables the feature to run microapps on the firmware.">Microapp</a>   </td><td class="markdownTableBodyRight">0x800   </td><td class="markdownTableBodyRight">2048   </td><td class="markdownTableBodyRight">2    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x2000FF00   </td><td class="markdownTableBodyCenter">IPC   </td><td class="markdownTableBodyRight">0x100   </td><td class="markdownTableBodyRight">256   </td><td class="markdownTableBodyRight">0.25    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyCenter"><b>Total</b>   </td><td class="markdownTableBodyRight">0x10000   </td><td class="markdownTableBodyRight">65536   </td><td class="markdownTableBodyRight">64   </td></tr>
</table>
<p >The bluenet heap starts at <code>0x20002A00</code> and grows up to the bluenet stack. The stack starts at <code>0x2000F6FF</code> and grows down to the heap. The microapp stack grows down from <code>0x2000FEFF</code> to <code>0x2000F700</code>.</p>
<p >In bootloader mode, RAM is (see the <a href="https://github.com/crownstone/bluenet/blob/master/source/bootloader/secure_bootloader_gcc_nrf52.ld">bootloader linker file</a>):</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Start address   </th><th class="markdownTableHeadCenter">What   </th><th class="markdownTableHeadRight">Size   </th><th class="markdownTableHeadRight">Size   </th><th class="markdownTableHeadRight">Size (kB)    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x20000000   </td><td class="markdownTableBodyCenter">SD + offset   </td><td class="markdownTableBodyRight">0x3118   </td><td class="markdownTableBodyRight">12568   </td><td class="markdownTableBodyRight">12.273    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x20003118   </td><td class="markdownTableBodyCenter">Bootloader heap/stack   </td><td class="markdownTableBodyRight">0xCDE8   </td><td class="markdownTableBodyRight">52712   </td><td class="markdownTableBodyRight">51.477    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0000FF00   </td><td class="markdownTableBodyCenter">IPC   </td><td class="markdownTableBodyRight">0x100   </td><td class="markdownTableBodyRight">256   </td><td class="markdownTableBodyRight">0.250    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyCenter"><b>Total</b>   </td><td class="markdownTableBodyRight">0x10000   </td><td class="markdownTableBodyRight">65536   </td><td class="markdownTableBodyRight">64   </td></tr>
</table>
<p >The offset is called <code>RAM_BOOTLOADER_START_OFFSET</code> and is of size <code>0x718</code>. When the bootloader is running there are no microapps, hence that part of RAM can be safely used.</p>
<h1><a class="anchor" id="autotoc_md358"></a>
Memory layout on the nRF52840</h1>
<p >The nRF52840 has 1 MB flash and 256 kB RAM. An individual page is 4 kB (<code>0x1000</code> in hex), hence there is space for 256 pages.</p>
<p >See the <a href="https://github.com/crownstone/bluenet/blob/master/source/conf/cmake/CMakeBuild.config.default">default config file</a>, the <a href="https://github.com/crownstone/bluenet/blob/master/config/nrf52840/CMakeBuild.config">nrf52840 target file</a>, and the <a href="https://github.com/crownstone/bluenet/blob/master/source/include/third/nrf/generic_gcc_nrf52.ld">bluenet linker file</a>.</p>
<h2><a class="anchor" id="autotoc_md359"></a>
Flash</h2>
<p >The global layout of the flash memory is shown below for the nRF52840:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Start address   </th><th class="markdownTableHeadCenter">What   </th><th class="markdownTableHeadRight">Nr of pages   </th><th class="markdownTableHeadLeft">Config    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x00000000   </td><td class="markdownTableBodyCenter">MBR   </td><td class="markdownTableBodyRight">1   </td><td class="markdownTableBodyLeft">fixed    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x00001000   </td><td class="markdownTableBodyCenter">SD   </td><td class="markdownTableBodyRight">37   </td><td class="markdownTableBodyLeft">location: fixed <br  />
 size: implicit    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x00026000   </td><td class="markdownTableBodyCenter">App / Bluenet   </td><td class="markdownTableBodyRight">54   </td><td class="markdownTableBodyLeft">APPLICATION_START_ADDRESS<br  />
 implicit    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0005C000   </td><td class="markdownTableBodyCenter">Free   </td><td class="markdownTableBodyRight">129   </td><td class="markdownTableBodyLeft">implicit    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x000DD000   </td><td class="markdownTableBodyCenter"><a class="el" href="classMicroapp.html" title="Class that enables the feature to run microapps on the firmware.">Microapp</a>   </td><td class="markdownTableBodyRight">16   </td><td class="markdownTableBodyLeft">FLASH_MICROAPP_BASE <br  />
 FLASH_MICROAPP_PAGES    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x000ED000   </td><td class="markdownTableBodyCenter">P2P DFU   </td><td class="markdownTableBodyRight">1   </td><td class="markdownTableBodyLeft">location: implicit<br  />
 size: fixed    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x000EE000   </td><td class="markdownTableBodyCenter">Reserved for FDS expansion   </td><td class="markdownTableBodyRight">4   </td><td class="markdownTableBodyLeft">location: implicit <br  />
 CS_FDS_VIRTUAL_PAGES_RESERVED_BEFORE    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x000F2000   </td><td class="markdownTableBodyCenter">FDS   </td><td class="markdownTableBodyRight">4   </td><td class="markdownTableBodyLeft">location: implicit <br  />
 CS_FDS_VIRTUAL_PAGES    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x000F6000   </td><td class="markdownTableBodyCenter">Bootloader   </td><td class="markdownTableBodyRight">7   </td><td class="markdownTableBodyLeft">BOOTLOADER_START_ADDRESS <br  />
 BOOTLOADER_LENGTH    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x000FD000   </td><td class="markdownTableBodyCenter">Reserved for bootloader expansion   </td><td class="markdownTableBodyRight">1   </td><td class="markdownTableBodyLeft">location: implicit<br  />
 size: fixed    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x000FE000   </td><td class="markdownTableBodyCenter">MBR settings   </td><td class="markdownTableBodyRight">1   </td><td class="markdownTableBodyLeft">CS_MBR_PARAMS_PAGE_ADDRESS <br  />
 size: fixed    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x000FF000   </td><td class="markdownTableBodyCenter">Bootloader settings   </td><td class="markdownTableBodyRight">1   </td><td class="markdownTableBodyLeft">CS_BOOTLOADER_SETTINGS_ADDRESS <br  />
 size: fixed   </td></tr>
</table>
<p>| | <b>Total</b> | 256</p>
<p >The microapp section is larger than on the nRF52832.</p>
<p >The maximum size of the app is available as <code>APPLICATION_MAX_LENGTH</code>. For 54 + 129 pages this amounts to <code>(54 + 129) * 0x1000 = 0xB7000</code>. This is about 732 kB. For a dual bank bootloader the firmware should than be 366 kB max so the old firmware can exist temporarily alongside the new firmware. This is possible on the nRF52840, but that doesn't mean that it's in use. The build will fail if the app binary will go beyond the address <code>FLASH_MICROAPP_BASE</code> (<code>0xDD000</code>).</p>
<h2><a class="anchor" id="autotoc_md360"></a>
RAM</h2>
<p >The layout for RAM memory is shown below for the nRF52840:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Start address   </th><th class="markdownTableHeadCenter">What   </th><th class="markdownTableHeadRight">Size   </th><th class="markdownTableHeadRight">Size   </th><th class="markdownTableHeadRight">Size (kB)    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x20000000   </td><td class="markdownTableBodyCenter">SD   </td><td class="markdownTableBodyRight">0x2A00   </td><td class="markdownTableBodyRight">10752   </td><td class="markdownTableBodyRight">10.5    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x20002A00   </td><td class="markdownTableBodyCenter">App heap and stack   </td><td class="markdownTableBodyRight">0x3CD00   </td><td class="markdownTableBodyRight">249088   </td><td class="markdownTableBodyRight">243.25    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x2003F700   </td><td class="markdownTableBodyCenter"><a class="el" href="classMicroapp.html" title="Class that enables the feature to run microapps on the firmware.">Microapp</a>   </td><td class="markdownTableBodyRight">0x800   </td><td class="markdownTableBodyRight">2048   </td><td class="markdownTableBodyRight">2    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x2003FF00   </td><td class="markdownTableBodyCenter">IPC   </td><td class="markdownTableBodyRight">0x100   </td><td class="markdownTableBodyRight">256   </td><td class="markdownTableBodyRight">0.25    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"></td><td class="markdownTableBodyCenter"><b>Total</b>   </td><td class="markdownTableBodyRight">0x40000   </td><td class="markdownTableBodyRight">262144   </td><td class="markdownTableBodyRight">256   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md361"></a>
Miscellaneous</h1>
<p >There is support for 255 mesh devices (this in contrast with 40 devices that we supported first). This increases RAM usage by around 1500 bytes. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
