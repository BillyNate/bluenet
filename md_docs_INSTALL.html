<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: Installation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_docs_INSTALL.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Installation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md17"></a>
Prerequisites</h1>
<p>Bluenet uses the <code>cmake</code> build system, <code>git</code> as versioning system, and <code>wget</code> to retrieve other files. </p><pre class="fragment">sudo apt install cmake git wget python3 python3-pip
</pre><p> Note: In newer Ubuntu version you might get an unmet dependency issue for <em>libncurses5</em>. To fix this issue simply run the command: </p><pre class="fragment">sudo apt --fix-broken install
</pre> <h1><a class="anchor" id="autotoc_md18"></a>
Getting the Bluenet code</h1>
<p>The best way is to first <a href="https://github.com/crownstone/bluenet/fork">fork</a> the bluenet repository.</p>
<p><a href="https://github.com/crownstone/bluenet/fork"><img src="https://img.shields.io/badge/fork-bluenet-blue" alt="Fork" class="inline"/> </a> </p>
<p>Create a workspace folder where all the necessary files and folders will be stored, e.g. </p><pre class="fragment">mkdir -p ~/workspace
</pre><p> and download the code: </p><pre class="fragment">git clone https://github.com/YOUR_GITHUB_USERNAME/bluenet
</pre><p> and set the correct upstream: </p><pre class="fragment">cd bluenet
git remote add upstream git@github.com:crownstone/bluenet.git
</pre> <h1><a class="anchor" id="autotoc_md19"></a>
Setup</h1>
<p>The installation uses CMake. To start, you can simply use: </p><pre class="fragment">cd bluenet
mkdir build &amp;&amp; cd build
cmake .. &amp;&amp; make
</pre><p> This will download the required programs and libraries. The installation has been tested on Ubuntu 18.04 (should work on newer ones as well) and assumes you use a J-Link programmer.</p>
<p>By default a <code>default</code> target will be build. It is possible to build for that target by navigating into its build directory: </p><pre class="fragment">cd build/default
make
</pre> <h1><a class="anchor" id="autotoc_md20"></a>
Flashing</h1>
<p>Different commands to write to a board (flashing) use <code>nrfjprog</code> under the hood.</p>
<p>To clear the target device completely: </p><pre class="fragment">cd build
make erase
</pre><p> To write the softdevice: </p><pre class="fragment">cd build
make write_softdevice
</pre><p> This will also erase the pages if there is already code on this.</p>
<p>To check the version of a softdevice: </p><pre class="fragment">make read_softdevice_version
</pre><p> If you type <code>make</code> and then TAB there should be tab completion that shows the possible targets.</p>
<p>The softdevice makes use of a so called master boot record (MBR). This provides the softdevice, bootloader, and firmware some functions. It requires a parameter page, which it finds by looking at the UICR. We write the address with: </p><pre class="fragment">make write_mbr_param_address
</pre><p> Before writing the application or bootloader, the board version should be written. It allows <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> to run the same binary on all our devices and decide per device what type of hardware is actually present. For example, on a Guidestone there will be no switch functionality available. It has to be written before the application runs, else the application will write a default. </p><pre class="fragment">cd build/default
make write_board_version
</pre><p> The bootloader is build automatically when you build the firmware, it can also be flashed to the target board. The value of its start address is written to UICR separately.</p>
<p>To write the bootloader and its address: </p><pre class="fragment">cd build/default/bootloader
make write_bootloader
make write_bootloader_address
</pre><p> Then write the application: </p><pre class="fragment">cd build/default
make write_application
</pre><p> The bootloader requires a bootloader settings page that contains information about the current DFU process. It also contains information about the installed application and its version. The bootloader verifies if the application is correct by checking it against the bootloader settings, so each time the application changes, you the bootloader settings also change.</p>
<p>To build and write the bootloader settings: </p><pre class="fragment">cd build/default
make build_bootloader_settings
make write_bootloader_settings
</pre><p> Now that everything is written, the board has to be reset: </p><pre class="fragment">cd build
make reset
</pre> <h1><a class="anchor" id="autotoc_md21"></a>
DFU (over the air updates)</h1>
<p>In order to create DFU packages, the firmware has to be signed. For this, <a href="https://www.passwordstore.org/">pass</a> is used to store the signing keys.</p>
<p>TODO: make target to generate signing key.</p>
<p>Now it becomes possible to create a dfu package to update the application through: </p><pre class="fragment">cd build/default
make generate_dfu_package_application
</pre><p> Dependencies between these steps might need to be included.</p>
<p>It is possible to set what entry in <code>pass</code> is used: </p><pre class="fragment">PASS_FILE=your_pass_store/dfu_pkg_signing_key
</pre><p> The contents of this file when executing on the command-line: </p><pre class="fragment">pass your_pass_store/dfu_pkg_signing_key
</pre><p> should be something like: </p><pre class="fragment">-----BEGIN EC PRIVATE KEY------
...
...
-----END EC PRIVATE KEY------
</pre><h1><a class="anchor" id="autotoc_md22"></a>
Summary</h1>
<p>All build specific commands should be run from the target directory, while non-build specific commands can be run from the build directory. To write everything, for now you will need the following series of commands. </p><pre class="fragment">cd build
make erase
make write_softdevice
cd default
make write_board_version
make write_application
make write_bootloader_settings
cd bootloader
make write_bootloader
make write_bootloader_address
</pre><p> If the dust settles we might have one single <code>make write_all</code> command as well. Keep tight. :-)</p>
<h1><a class="anchor" id="autotoc_md23"></a>
Logs</h1>
<p>You can find more on logs (over UART) in this document.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
Debug with GDB</h1>
<p>To start debugging the target, run first in a separate console: </p><pre class="fragment">cd build/default
make debug_server
</pre><p> Then run the debug session in another console: </p><pre class="fragment">make debug_application
</pre><h1><a class="anchor" id="autotoc_md25"></a>
Configuration</h1>
<p>If you want to configure for a different target, go to the <code>config</code> directory in the workspace and copy the default configuration files to a new directory, say <code>board0</code>. </p><pre class="fragment">cd config
cp -r default board0
</pre><p> Go to the build </p><pre class="fragment">cd build
cmake .. -DBOARD_TARGET=board0
make
</pre><p> The other commands are as in the usual setting.</p>
<p>Note, now, if you change a configuration setting you will also need to run <code>CMake</code> again. It picks up the configuration settings at configuration time and then passes them as defines to <code>CMake</code> in the bluenet directory. </p><pre class="fragment">cd build
cmake ..
make
</pre><p> Only after this you can assume that the <code>make</code> targets in <code>build/default</code> or any other target are up to date.</p>
<h1><a class="anchor" id="autotoc_md26"></a>
Advanced</h1>
<h2><a class="anchor" id="autotoc_md27"></a>
Overwrites and runtime configs</h2>
<p>The following is convenient if you have multiple boards attached to your system.</p>
<p>It is possible to have a second file in your target directory that overwrites values in your <code>CMakeBuild.config</code>. The file is called <code>CMakeBuild.overwrite.config</code>.</p>
<p>For example to flash to two different boards, both attached to a USB port. </p><pre class="fragment">cd build
make list_jlinks
</pre><p> Note the serial number of your JLink device and add it to for example <code>config/default/CMakeBuild.overwrite.config</code>. </p><pre class="fragment">SERIAL_NUM=682450212
</pre><p> On the moment there is no rebuild triggered when the values in this file change.</p>
<p>Another convenient variable to set there is <code>GDB_PORT</code>. To have both running in parallel: </p><pre class="fragment">cd build
cmake .. -DBOARD_TARGET=board0 &amp;&amp; make
cd build/board0
make debug_server
cmake .. -DBOARD_TARGET=board1 &amp;&amp; make
cd build/board1
make debug_server
</pre><p> For in particular the above information you perhaps do not want to have everything recompiled just because you use a particular JLINK device. The file that is used for runtime only is <code>CMakeBuild.runtime.config</code>. If you write something like <code>SERIAL_NUM=682450212</code> in that file this can be altered without causing <code>cmake</code> to run again.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Wireless</h2>
<p>Information about the MAC address can be obtained through the make system as well: </p><pre class="fragment">make read_mac_address
</pre><p> The address is stored by Nordic as 48 bits in two registers, <code>DEVICEADDR[0]</code> and <code>DEVICEADDR[1]</code>. Depending on the last two bits, this is a static or a private address (resolvable or non-resolvable). Those bits are normally set to 00, but due to the fact that the Crownstones are static addresses, we set them to 11. This means we can use the result to connect to the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> (for the setup process for instance).</p>
<p>Note that reading out UICR/FICR registers can cause the firmware to halt. Run <code>make reset</code> afterwards.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Setup</h2>
<p>It is possible to make use of the <code>csutil</code> utility which can be sourced through a cmake flag: </p><pre class="fragment">cmake .. -DDOWNLOAD_CSUTIL=ON      # and other flags
</pre><p> You can prepare the configuration used to set up a <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> by </p><pre class="fragment">make write_config
</pre><p> Or individually as </p><pre class="fragment">BLUENET_CONFIG=MAC_ADDRESS make write_config
BLUENET_CONFIG=IBEACON_MINOR make write_config
...
</pre><p> This will write a <code>CMakeBuild.dynamic.config</code> file locally. To perform the setup, run </p><pre class="fragment">make setup
</pre><p> This will generate a <code>config.json</code> file with the proper information and use the <code>csutil</code> tool to perform the setup. You can also do a factory reset. </p><pre class="fragment">make factory_reset
</pre><p> The <code>csutil</code> tool uses the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> BLE library under the hood. That means that you can also setup hardware that is not attached to your machine. In that case make sure you have the right config values set (e.g. in <code>CMakeBuild.runtime.config</code>).</p>
<h1><a class="anchor" id="autotoc_md30"></a>
Running in a VM</h1>
<p>It is recommended to use a virtual machine (running Ubuntu 18.04 or newer) for compiling/developing bluenet if you're basic operating system is different (e.g. on archlinux).</p>
<p>The user of the host machine has to be added to the vboxusers group. Log out and back in after running this command. </p><pre class="fragment">sudo gpasswd -a m vboxusers
</pre><p> Also it is recommended to check if a J-Link programmer is correctly connected on the host machine. </p><pre class="fragment">lsusb | grep J-Link
</pre><p> For VirtualBox "guest editions" has to be installed on the Ubuntu virtual machine. Insert the guest editions into the VM by going to the bar menu and pressing "Devices &gt; Insert guest editions". Ubuntu should show a pop up to help you further.</p>
<p>After this setup go to the bar menu to "Devices &gt; USB &gt; &lt;J link name&gt;". After selecting the J-link run the following command in the Ubuntu VM to check if the J-link correctly setup. </p><pre class="fragment">lsusb | grep J-Link
</pre> <h1><a class="anchor" id="autotoc_md31"></a>
Common issues</h1>
<p>On older ubuntu versions, python2.7 is the default version. This gives issues with nrfutil.</p>
<p>This can be fixed by installing pip2, removing nrfutil from pip3, and installing nrfutil with pip2.</p>
<h1><a class="anchor" id="autotoc_md32"></a>
Maintainers</h1>
<p>Not for everyday users, just for maintainers of this code base, there are more options. A few of the options are described in the Build System document.</p>
<p>There are a few other options which can be found as well by typing <code>make</code>, a space and then TAB. Some examples:</p>
<p>For a linter (cppcheck): </p><pre class="fragment">make check
</pre><p> For documentation: </p><pre class="fragment">make generate_documentation
make view_documentation
</pre><p> By the way, to remove dependency checking, <code>CMake</code> introduces for each target also a fast variant. For example, the <code>debug</code> target depends on the <code>${PROJECT_NAME}.elf</code> target </p><pre class="fragment">make debug
</pre><p> To actually only run <code>debug</code>, just type: </p><pre class="fragment">make debug/fast
</pre><p> This option exists for almost all targets.</p>
<h1><a class="anchor" id="autotoc_md33"></a>
Feedback</h1>
<p>If there are bugs in the build process, please indicate so.</p>
<p>The default installation procedure is done through continuous integration. If it is successful you will see a proper building button:</p>
<p><a href="https://travis-ci.org/crownstone/bluenet"><img src="https://travis-ci.org/crownstone/bluenet.svg?branch=master" alt="Build Status" style="pointer-events: none;" class="inline"/></a></p>
<p>In that case, check your system to see if you've done something peculiar. :-) </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
