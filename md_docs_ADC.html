<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: # ADC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_ADC.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"># <a class="el" href="classADC.html" title="Analog-Digital conversion.">ADC</a> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The <a class="el" href="classADC.html" title="Analog-Digital conversion.">ADC</a> samples one or multiple pins using the SAADC peripheral.</p>
<h1><a class="anchor" id="autotoc_md178"></a>
Normal operation</h1>
<p >In normal operation the <a class="el" href="classADC.html" title="Analog-Digital conversion.">ADC</a> works roughly like this:</p>
<ol type="1">
<li>The SAADC is given a 2 buffers.</li>
</ol>
<ul>
<li>The SAADC fills the first buffer with sampled values, every time a hardware timer ticks.</li>
<li>The SAADC triggers an interrupt that the buffer is filled, and continues with the second buffer.</li>
<li>The first buffer is processed by the user.</li>
<li>The first buffer is given to the SAADC.</li>
<li>Etc.</li>
</ul>
<p >A detailed diagram can be found <a href="uml/adc/normal-operation.svg">here</a>.</p>
<h1><a class="anchor" id="autotoc_md179"></a>
Offset in samples</h1>
<p >There can be an offset in the samples in the buffer. The voltage and current values are interleaved. An odd offset makes voltage values current values and the other way around. This is <b>not</b> offset due to temperature. (For this the <a class="el" href="classADC.html" title="Analog-Digital conversion.">ADC</a> needs to be <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fcom.nordic.infocenter.nrf52832.ps.v1.1%2Fsaadc.html&amp;cp=2_1_0_36_5&amp;anchor=saadc_easydma">recalibrated</a> at times).</p>
<p >The engineers at Nordic are quite aware of this issue. However, the proposed solution in practice has not been sufficient.</p>
<ul>
<li><a href="https://devzone.nordicsemi.com/f/nordic-q-a/20291/offset-in-saadc-samples-with-easy-dma-and-ble">https://devzone.nordicsemi.com/f/nordic-q-a/20291/offset-in-saadc-samples-with-easy-dma-and-ble</a></li>
<li><a href="https://devzone.nordicsemi.com/f/nordic-q-a/16885/saadc-scan-mode-sample-order-is-not-always-consistent/134614#134614">https://devzone.nordicsemi.com/f/nordic-q-a/16885/saadc-scan-mode-sample-order-is-not-always-consistent/134614#134614</a></li>
<li><a href="https://devzone.nordicsemi.com/f/nordic-q-a/36443/glitches-in-adc-sampling">https://devzone.nordicsemi.com/f/nordic-q-a/36443/glitches-in-adc-sampling</a></li>
</ul>
<p >The "solution" is to actually use the PPI to trigger the START task on an END event. Say channel <code>1</code>. We do this in <a href="https://github.com/crownstone/bluenet/blob/master/source/src/drivers/cs_ADC.cpp#L203">drivers/cs_ADC.cpp</a>: </p><pre class="fragment">_ppiChannelStart = getPpiChannel(CS_ADC_PPI_CHANNEL_START+1);
nrf_ppi_channel_endpoint_setup(
      _ppiChannelStart,
      nrf_saadc_event_address_get(NRF_SAADC_EVENT_END),
      nrf_saadc_task_address_get(NRF_SAADC_TASK_START)
</pre><p> What this solves is that a SAMPLE event is not accidentally sent to the <a class="el" href="classADC.html" title="Analog-Digital conversion.">ADC</a> before a TASK_START after an END event. If there is a single sample event missing at the beginning of the buffer all voltage/current values are indeed exchanged.</p>
<p >What is suggested <a href="https://devzone.nordicsemi.com/f/nordic-q-a/20291/offset-in-saadc-samples-with-easy-dma-and-ble">by Bart</a> is that <code>RESULT.PTR</code> is set too late. This pointer is double-buffered. It can be updated and prepared for the next <code>START</code> event immediately after a <code>STARTED</code> event has been generated. Namely, after <code>START</code> the contents of this register is copied into an internal SAADC register.</p>
<ol type="1">
<li>Let's assume <code>RESULT.PTR</code> is not set after processing the buffer (a copy action or worse which can take considerable amount of time), but immediately after a <code>STARTED</code> event.</li>
<li>This means that for a period of a buffer (a couple of milliseconds), there has been no way to deliver a <code>STARTED</code> event.</li>
<li>Or the function (running on a low interrupt level) that checks for <code>STARTED</code> didn't get CPU time yet. There is a <a href="https://github.com/crownstone/bluenet/blob/master/source/src/drivers/cs_ADC.cpp#L488">while loop</a> in addBufferToSampleQueue.</li>
</ol>
<p >Things to check:</p>
<ol type="1">
<li>Do we indeed do no processing of the buffer before we set <code>RESULT.PTR</code>? We really shouldn't... Rather indicate a buffer as dirty / non-processed and disregard in software</li>
<li>Is there no way to pick up the <code>STARTED</code> event in an interrupt service routine and set <code>RESULT.PTR</code> from there?</li>
</ol>
<h1><a class="anchor" id="autotoc_md180"></a>
Delays</h1>
<p >However, sometimes the CPU is busy. This can lead to the processing being delayed, or the interrupt being delayed. If that happens, the SAADC doesn't get a new buffer before the previous buffer has been filled. But since the hardware timer keeps on ticking, the SAADC keeps sampling, with no place to leave the samples. They get discarded and you end up with a gap in measurements and in case of multiple pins, values on the wrong place.</p>
<p >To safeguard against these issues, there is a timeout timer that is stopped every time a buffer has been processed, and started when a new buffer is being filled.</p>
<p >If a timeout occurs, the <a class="el" href="classADC.html" title="Analog-Digital conversion.">ADC</a> is stopped and restarted. It will wait for every buffer to be processed before restarting.</p>
<p >See the detailed diagrams for <a href="uml/adc/delayed-processing.svg">delayed processing</a> and <a href="uml/adc/delayed-interrupt.svg">delayed interrupt</a>.</p>
<h1><a class="anchor" id="autotoc_md181"></a>
Configuration change</h1>
<p >The config of the <a class="el" href="classADC.html" title="Analog-Digital conversion.">ADC</a> can be reconfigured on the fly. The <a class="el" href="classADC.html" title="Analog-Digital conversion.">ADC</a> will wait until a buffer is filled, then it will stop the <a class="el" href="classADC.html" title="Analog-Digital conversion.">ADC</a>, reconfigure the SAADC, restart, and finally let the buffer be processed. Again, it will only actually start when the buffer has been processed. See the <a href="uml/adc/config-change.svg">diagram</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
