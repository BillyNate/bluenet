<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: Microapps</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_MICROAPP.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Microapps </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The protocol has to be designed yet. Currently, there are a few functions implemented with a hint of a protocol. At the microapp code side this will be completely hidden for the user, hence this protocol definition has to be seen as a definition for someone who wants to understand how the microapp code maps to bluenet functionality. However, for certain functions there are user-facing results.</p>
<p >This document describes:</p>
<ul>
<li>User-facing definitions</li>
<li><a class="el" href="classMicroapp.html" title="Class that enables the feature to run microapps on the firmware.">Microapp</a> SDK protocol (to which a microapp/arduino library should adhere to)</li>
<li><a class="el" href="classMicroapp.html" title="Class that enables the feature to run microapps on the firmware.">Microapp</a> upload protocol (how to get a microapp on a device that runs bluenet)</li>
<li><a class="el" href="classMicroapp.html" title="Class that enables the feature to run microapps on the firmware.">Microapp</a> binary format (a microapp has a binary header with meta-information)</li>
<li>Implementation details</li>
</ul>
<p >In the end, as a user of microapps, only the user-facing definitions are important. This document goes way beyond that and describes everything on a level that would allow someone to write their own libs and/or upload tools.</p>
<h1><a class="anchor" id="autotoc_md127"></a>
User-facing definitions</h1>
<p >An implementation of a microapp can be found <a href="https://github.com/mrquincle/crownstone-bluenet-module">here</a>. It has a so-called <code>.ino</code> file with Arduino-like syntax:</p>
<div class="fragment"><div class="line">static int counter = 0;</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">    Serial.begin();</div>
<div class="line">    Serial.write(&quot;Hello world!&quot;);</div>
<div class="line">    Serial.write(counter);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">int loop() {</div>
<div class="line">    counter++;</div>
<div class="line"> </div>
<div class="line">    // every 5 seconds</div>
<div class="line">    if (counter % 5 == 0) {</div>
<div class="line">        digitalWrite(1, 1);</div>
<div class="line">        delay(1000);</div>
<div class="line">        digitalWrite(1, 0);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p >Here the relay is mapped to pin <code>1</code> and the value written with <code>digitalWrite</code> turns it on or off. The delay function can be used to introduce a non-blocking delay. It is perfectly fine to write <code>delay(1000000)</code>, delay of 1000 seconds. The microapp code will then resume 1000 seconds later.</p>
<h1><a class="anchor" id="autotoc_md128"></a>
Microapp SDK protocol</h1>
<p >The protocol defines how microapp functions map to bluenet functionality, and how control is shared between the microapp and bluenet.</p>
<p >All microapp libraries that wish to access bluenet functionality have to do this via a call to <code>sendMessage()</code>. This function writes a request (or command) at a shared address in RAM according to the protocol defined below, and then yields to bluenet with a coroutine switch. Bluenet will handle the request and either resume its own tasks or hand back control to the microapp based on the type of request.</p>
<p >Bluenet can also make requests to the microapp, for example in the case of interrupts. The microapp may ask to be notified upon certain events within bluenet. Whenever such an event occurs, bluenet will write relevant event information in the shared RAM, again according to the protocol below. Then, bluenet calls the microapp which can handle the event and yield back once it has done so.</p>
<p >Shared protocol definitions are located in <code>/source/shared/cs_MicroappStructs.h</code>. The bluenet entry and exit points for the microapp are defined in <code>/source/src/microapp/cs_MicroappController.cpp</code> and handling the requests happens in <code>/source/src/microapp/cs_MicroappCommandHandler.cpp</code>.</p>
<h2><a class="anchor" id="autotoc_md129"></a>
Microapp protocol packets</h2>
<p >The remaining part of this section is dedicated to explaining the protocol for writing to the shared memory for the following functionalities that are supported as of now:</p><ul>
<li>Log</li>
<li>Delay</li>
<li>Pin (GPIO)</li>
<li><a class="el" href="classRelay.html" title="Class that provides a bi-stable relay.">Relay</a> / <a class="el" href="classDimmer.html" title="Class that provides a dimmer.">Dimmer</a></li>
<li><a class="el" href="classService.html" title="Service as defined in the GATT Specification.">Service</a> data</li>
<li>TWI</li>
<li>BLE</li>
<li>Power usage</li>
<li>Presence</li>
<li><a class="el" href="classMesh.html" title="Author: Crownstone Team Copyright: Crownstone (https://crownstone.rocks) Date: 12 Apr....">Mesh</a></li>
</ul>
<p ><img src="../docs/diagrams/microapp_command.png" alt="Microapp command" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">Includes command type    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Payload   </td><td class="markdownTableBodyNone">31   </td><td class="markdownTableBodyNone">Fields depending on command type   </td></tr>
</table>
<p ><img src="../docs/diagrams/microapp_header.png" alt="Microapp header" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Command type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Type of command determining interpretation of rest of command    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Id   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Id used for identifying the command    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Ack   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Field that can be used for acking commands (both directions)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Prev   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Reserved for future use    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">InterruptCmd   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">For interrupt commands, indicates the type of interrupt    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Counter   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Reserved for future use   </td></tr>
</table>
<p >The following command types are defined:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Command   </th><th class="markdownTableHeadNone">Command name   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x00   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Reserved    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x01   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_LOG</code>   </td><td class="markdownTableBodyNone">Print to serial (a log line in bluenet)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x02   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_DELAY</code>   </td><td class="markdownTableBodyNone">Delay microapp by calling bluenet and later on jumping back    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x03   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_PIN</code>   </td><td class="markdownTableBodyNone">Write/read to/from a virtual pin    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x04   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_SWITCH_DIMMER</code>   </td><td class="markdownTableBodyNone">Write/read to/from the relay/dimmer    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x05   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_SERVICE_DATA</code>   </td><td class="markdownTableBodyNone">Write service data (over the air)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x06   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_TWI</code>   </td><td class="markdownTableBodyNone">Read/write from twi/i2c device    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x07   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_BLE</code>   </td><td class="markdownTableBodyNone">Bluetooth Low Energy related commands    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x08   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_POWER_USAGE</code>   </td><td class="markdownTableBodyNone">Read power usage measured by crownstone    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x09   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_PRESENCE</code>   </td><td class="markdownTableBodyNone">Read presence detected    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0A   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_MESH</code>   </td><td class="markdownTableBodyNone">Bluetooth mesh related commands    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0B   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_SETUP_END</code>   </td><td class="markdownTableBodyNone">End of microapp setup function    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0C   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_LOOP_END</code>   </td><td class="markdownTableBodyNone">End of microapp loop    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0D   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_BLE_DEVICE</code>   </td><td class="markdownTableBodyNone">Bluetooth Low Energy device commands    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x0E   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_SOFT_INTERRUPT_RECEIVED</code>   </td><td class="markdownTableBodyNone">Confirm intention to handle interrupt    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x0F   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_SOFT_INTERRUPT_END</code>   </td><td class="markdownTableBodyNone">Handling interrupt has ended without error    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0x10   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_SOFT_INTERRUPT_ERROR</code>   </td><td class="markdownTableBodyNone">Error has occured within an interrupt handler    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">0x11   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_SOFT_INTERRUPT_DROPPED</code>   </td><td class="markdownTableBodyNone"><a class="el" href="classMicroapp.html" title="Class that enables the feature to run microapps on the firmware.">Microapp</a> too busy to handle interrupt   </td></tr>
</table>
<p >For further details, see the next sections.</p>
<h2><a class="anchor" id="autotoc_md130"></a>
Log</h2>
<p >The logging function accepts a type such as char, int, string, an option and then the data.</p>
<p ><img src="../docs/diagrams/microapp_log.png" alt="Microapp log" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">Log command (<code>CS_MICROAPP_COMMAND_LOG</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Type of value to be logged (char, int, string, array, float, double, uint, short)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Option   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Yes/no newline    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Data   </td><td class="markdownTableBodyNone">28   </td><td class="markdownTableBodyNone">Maximum string / array size   </td></tr>
</table>
<p >In the case of a string the last byte is set to 0 on the bluenet side (null-terminated), just an additional precaution. Note that we never rely on null-termination anyway (we always send along length as well).</p>
<p >The opcode is called <code>port</code> on the microapp side (for this command). The same objects and functions are called to write to the logs as to write the service data for example.</p>
<h2><a class="anchor" id="autotoc_md131"></a>
Delay</h2>
<p >The delay function accepts a delay in milliseconds. A delay less than one second will be ignored. This is a function that requires a pointer to the coroutine argument which is used in <code>yield</code>.</p>
<p ><img src="../docs/diagrams/microapp_delay.png" alt="Microapp delay" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">Sleep command (<code>CS_MICROAPP_COMMAND_DELAY</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint16   </td><td class="markdownTableBodyNone">Period   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">Period to sleep in milliseconds    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uintptr   </td><td class="markdownTableBodyNone">Coargs   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Pointer to coroutine arguments   </td></tr>
</table>
<p >The coroutine arguments with which <code>loop</code> is called are passed through, so we can <code>yield</code> and later on call <code>next</code> to jump back and forth before we finally <code>yield</code> at the end of <code>loop</code>.</p>
<h2><a class="anchor" id="autotoc_md132"></a>
Pin</h2>
<p >The pin command is defined for virtual pins.</p>
<p ><img src="../docs/diagrams/microapp_pin.png" alt="Microapp pin" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">Pin command (<code>CS_MICROAPP_COMMAND_PIN</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Pin   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Pin index (virtual)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Opcode1   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Set a pin mode or perform action (read/write)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Opcode2   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">If opcode1 = mode (pullup setting), if action (read/write/action)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Value   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Value to write    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Ack   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Acknowledgment    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint32   </td><td class="markdownTableBodyNone">Callback   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Address of callback (on receiving a GPIO interrupt)   </td></tr>
</table>
<p >The value to write is an on/off value for digitalWrites. It is an 8-bits analog value for analogWrites. For a pin mode command the value can be e.g. change, rising, or falling.</p>
<p >The acknowledgment setting is not used yet.</p>
<h2><a class="anchor" id="autotoc_md133"></a>
Dimmer / Switch</h2>
<p ><img src="../docs/diagrams/microapp_dimmer_switch.png" alt="Microapp dimmer switch" class="inline"/></p>
<p >The dimmer / switch command is used to control the dimmer and switch.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">Dimmer/Switch command (<code>CS_MICROAPP_COMMAND_SWITCH_DIMMER</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Opcode   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone"><code>CS_MICROAPP_COMMAND_SWITCH</code> or <code>CS_MICROAPP_COMMAND_DIMMER</code> for controlling the switch or the dimmer respectively.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Value   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Value to write. Binary (0 = off, 1 = on) for the switch, or an 8-bit intensity value for the dimmer.   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md134"></a>
Service data</h2>
<p >The service data command can be used to write data to a service data struct.</p>
<p ><img src="../docs/diagrams/microapp_service_data.png" alt="Microapp service data" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">Pin command (<code>CS_MICROAPP_COMMAND_SERVICE_DATA</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Type of value to be logged (char, int, string, array, float, double, uint, short)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Option   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Yes/no newline    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Data   </td><td class="markdownTableBodyNone">28   </td><td class="markdownTableBodyNone">Maximum string / array size   </td></tr>
</table>
<p >This uses exactly the same format as for writing logs under the hood. At the microapp side, the class <code>SerialServiceData</code> inherits from <code>SerialBase_</code> (just as <code>Serial</code> itself does).</p>
<h2><a class="anchor" id="autotoc_md135"></a>
TWI / I2C</h2>
<p >The twi (two-wire interface) command can be used to control twi devices. This bus is also called an i2c bus. Bluenet has to be compiled with <code>BUILD_TWI=1</code> for this functionality to be available. The bluenet device is always the initiator. It is possible to have multiple targets on the bus (with different addresses). Check power requirements in that case.</p>
<p ><img src="../docs/diagrams/microapp_twi.png" alt="Microapp twi" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone"><a class="el" href="classTwi.html" title="Class that implements twi/i2c.">Twi</a> command (<code>CS_MICROAPP_COMMAND_TWI</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Address   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Target address    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Opcode   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">TWI opcodes such as read, write, init, enable, and disable    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Length   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Length of data to be received (or sent)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Ack   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Acknowledgment received    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Stop   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Existence of a stop symbol    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Buffer   </td><td class="markdownTableBodyNone">26   </td><td class="markdownTableBodyNone">Maximum twi payload (1 up to 26 bytes)   </td></tr>
</table>
<p >In the microapp code this is available through the <code>Wire</code> class.</p>
<h2><a class="anchor" id="autotoc_md136"></a>
BLE</h2>
<p >For Bluetooth Low Energy functionalities, for now there is support for scanning advertisements. <a class="el" href="classMesh.html" title="Author: Crownstone Team Copyright: Crownstone (https://crownstone.rocks) Date: 12 Apr....">Mesh</a> functionalities are covered in the <code>CS_MICROAPP_COMMAND_MESH</code> command type. The microapp can register a handler when a device is scanned. Note that bluenet throttles the number of scanned devices for which an interrupt is generated. Also, bluenet has to be compiled with <code>BUILD_MESHING=1</code> since scanning is implemented in the mesh classes on the bluenet side. In the future, support for connecting to BLE peripherals may be added.</p>
<p ><img src="../docs/diagrams/microapp_ble.png" alt="Microapp ble" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">Ble command (<code>CS_MICROAPP_COMMAND_BLE</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Opcode   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Ble opcodes such as start, stop, set handler    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Id   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Index for handler    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Address   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">MAC address (reserved for future use)   </td></tr>
</table>
<p >For ble scanned devices, a different packet structure is used</p>
<p ><img src="../docs/diagrams/microapp_ble_device.png" alt="Microapp ble device" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">Ble device command (<code>CS_MICROAPP_COMMAND_BLE_DEVICE</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Type of scanned device    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Address Type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Ble address type    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Address   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">MAC address    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">int8   </td><td class="markdownTableBodyNone">RSSI   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Received signal strength    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Dlen   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Data length    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Data   </td><td class="markdownTableBodyNone">31   </td><td class="markdownTableBodyNone">Payload of scanned device   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md137"></a>
Power usage</h2>
<p >The power usage command can be used to read the measured power usage of the device plugged into the outlet of this crownstone.</p>
<p ><img src="../docs/diagrams/microapp_powerusage.png" alt="Microapp powerusage" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">Power usage command (<code>CS_MICROAPP_COMMAND_POWER_USAGE</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">int32   </td><td class="markdownTableBodyNone">PowerUsage   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Power usage   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md138"></a>
Presence</h2>
<p >The presence command can be used to request presence of profiles in the sphere.</p>
<p ><img src="../docs/diagrams/microapp_presence.png" alt="Microapp presence" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone">Presence command (<code>CS_MICROAPP_COMMAND_PRESENCE</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">ProfileId   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Requested profile    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint64   </td><td class="markdownTableBodyNone">PresenceBitMask   </td><td class="markdownTableBodyNone">8   </td><td class="markdownTableBodyNone">Bitmask of the requested profile in the locations within the sphere   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md139"></a>
Mesh</h2>
<p >The supported mesh functionalities at the moment include both sending and receiving mesh messages of the specific microapp type (<code>CS_MESH_MODEL_TYPE_MICROAPP</code>). Both broadcast and directed mesh messages are supported.</p>
<p ><img src="../docs/diagrams/microapp_mesh.png" alt="Microapp mesh" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone"><a class="el" href="classMesh.html" title="Author: Crownstone Team Copyright: Crownstone (https://crownstone.rocks) Date: 12 Apr....">Mesh</a> command (<code>CS_MICROAPP_COMMAND_MESH</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Opcode   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Type of mesh command (send, read, info)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">StoneId   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Id of stone (to send to, read from, or own id)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Dlen   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Length of data field    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8[]   </td><td class="markdownTableBodyNone">Data   </td><td class="markdownTableBodyNone">7   </td><td class="markdownTableBodyNone">1 to 7 bytes (max mesh message payload length)   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md140"></a>
Soft interrupts</h2>
<p >For soft interrupts, the microapp has to acknowledge an interrupt from bluenet before handling the interrupt. This acknowledgement contains a field for the remaining number of interrupts that the microapp can process. Bluenet will keep this in mind and stop sending interrupts if the microapp is busy.</p>
<p ><img src="../docs/diagrams/microapp_interrupts.png" alt="Microapp interrupts" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">&ndash;   </td><td class="markdownTableBodyNone">Header   </td><td class="markdownTableBodyNone">6   </td><td class="markdownTableBodyNone"><a class="el" href="classMesh.html" title="Author: Crownstone Team Copyright: Crownstone (https://crownstone.rocks) Date: 12 Apr....">Mesh</a> command (<code>CS_MICROAPP_COMMAND_SOFT_INTERRUPT_RECEIVED</code> or <code>CS_MICROAPP_COMMAND_SOFT_INTERRUPT_DROPPED</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">EmptyInterruptSlots   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Number of empty slots for interrupts the microapp has   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md141"></a>
Microapp upload protocol</h1>
<p >The protocol to upload microapps can be found in the <a class="el" href="md_docs_protocol_PROTOCOL.html">protocol</a> doc.</p>
<h1><a class="anchor" id="autotoc_md142"></a>
Microapp binary format</h1>
<p >The binary format of a microapp.</p>
<p >TBD.</p>
<h1><a class="anchor" id="autotoc_md143"></a>
Implementation</h1>
<h2><a class="anchor" id="autotoc_md144"></a>
Calling the loop function</h2>
<p >The callLoop function in the microapp code will be called with <code>cntr = 0</code> the first time. At this moment it sets up a coroutine. The function in <code>cs_MicroApp.cpp</code> is more complex, but if we would call a function locally - within the same file - it would look like the following:</p>
<div class="fragment"><div class="line">void MicroApp::callLoop(int &amp; cntr, int &amp; skip) {</div>
<div class="line">    if (cntr == 0) {</div>
<div class="line">        _coargs = {&amp;_coroutine, 1, 0};</div>
<div class="line">        start(&amp;_coroutine, &amp;loop_local, &amp;_coargs);</div>
<div class="line">    }</div>
<div class="line">    ...</div>
</div><!-- fragment --><p >You see that a function <code>loop_local</code> will be called (later on) with as arguments <code>_coargs</code>. This function will be called using a different stack from the main program! You can check this by logging the stack pointer as shown in the following possible implementation of a <code>loop_local</code> function.</p>
<div class="fragment"><div class="line">#define get_sp(p) asm volatile(&quot;mov %0, sp&quot; : &quot;=r&quot;(p) : : )</div>
<div class="line"> </div>
<div class="line">void loop_local(void *p) {</div>
<div class="line">    LOGi(&quot;Loop locally..&quot;);</div>
<div class="line">    coargs* args = (coargs*) p;</div>
<div class="line">    void* sp;</div>
<div class="line">    get_sp(sp);</div>
<div class="line">    LOGi(&quot;Stack pointer at 0x%x&quot;, sp);</div>
<div class="line">    for (int i = 0; i &lt; 2; ++i) {</div>
<div class="line">        args-&gt;cntr++;</div>
<div class="line">        args-&gt;delay = (i+1)*10;</div>
<div class="line">        yield(args-&gt;c);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p >The <code>loop_local</code> function either just returns or "yields" with <code>yield</code> and the coroutine struct as argument. When it yields it will return to the main bluenet program. Due to the fact that we use a separate stack we do not need to worry about stack corruption. We just jump back exactly where we were (implementation detail: in <code>start</code> or <code>next</code>).</p>
<h2><a class="anchor" id="autotoc_md145"></a>
The loop function</h2>
<p >The actual loop function jumps to microapp code and back through function pointers stored by the microapp and the bluenet code in <code>IPC_RAM_DATA</code>. In the end it ends up in <code>microapp_callback</code>. Here we can <code>yield</code> as long as we have preserved the pointer to the <code>coargs</code> struct. In the microapp code we store this pointer on each call and put it in the payload if we callback with the delay opcode. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
