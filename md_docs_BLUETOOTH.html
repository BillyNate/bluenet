<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: Bluetooth Low Energy</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_BLUETOOTH.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Bluetooth Low Energy </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Bluetooth Low Energy or Bluetooth LE (the Bluetooth SIG group does not want you to use BLE as an abbreviation) is supported on most of the modern smartphones. Bluetooth LE is quite different from legacy Bluetooth. We will describe the aspects to it that are important for hardware running the bluenet firmware.</p>
<p >There are seven ways the Bluetooth LE radio is used in bluenet.</p>
<ol type="1">
<li><b>Receive connection commands</b>. To get commands from a smartphone (or hub) through a connection, see the <a class="el" href="md_docs_protocol_PROTOCOL.html">connection protocol</a>.</li>
<li><b>Receive connectionless commands</b>. To receive (mostly by smartphone) broadcasted Bluetooth LE advertisements, see the <a class="el" href="md_docs_protocol_BROADCAST_PROTOCOL.html">broadcast protocol</a>.</li>
<li><b>Receive connectionless presence</b>. To receive any type of Bluetooth LE advertisement, for in-network presence detection and in-network localization (not yet documented).</li>
<li><b>Send connectionless state</b>. To broadcast data from bluenet about the state of the device towards smartphones etc., see the <a class="el" href="md_docs_protocol_SERVICE_DATA.html">service data protocol</a>.</li>
<li><b>Send connectionless presence</b>. To broadcast anchor information for indoor localization in the form of iBeacon messages, see <a class="el" href="md_docs_LOCALIZATION.html">localization</a>.</li>
<li><b>Send and receive over mesh</b>. To communicate with other bluenet devices using Bluetooth <a class="el" href="classMesh.html" title="Author: Crownstone Team Copyright: Crownstone (https://crownstone.rocks) Date: 12 Apr....">Mesh</a>, see the <a class="el" href="md_docs_MESH.html">mesh overview</a> and <a class="el" href="md_docs_protocol_MESH_PROTOCOL.html">mesh protocol</a> documents.</li>
<li><b>Send connection commands</b>. To set up a connection to other Crownstones or other Bluetooth LE devices (not yet documented).</li>
</ol>
<h2><a class="anchor" id="autotoc_md80"></a>
Bluetooth LE packet</h2>
<p >The structure of a Bluetooth LE packet is as follows.</p>
<p ><img src="../docs/diagrams/ble-packet.png" alt="BLE packet" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Preamble   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Preamble    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Access Address   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Bluetooth LE address    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">PDU   </td><td class="markdownTableBodyNone">257   </td><td class="markdownTableBodyNone">Protocol Data Unit (2-257 bytes)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">CRC   </td><td class="markdownTableBodyNone">3   </td><td class="markdownTableBodyNone">Checksum   </td></tr>
</table>
<p >This is on the so-called link layer. More information can be found further down in this text.</p>
<h1><a class="anchor" id="autotoc_md81"></a>
Receive connection commands</h1>
<p >It is possible to send some commands in a connectionless manner through encrypted advertisements which are broadcasted from a smartphone (see next section). However, it is hard to have this working properly on iOS in the background. Hence, we require connections to send on, off, dim, and other commands to the device running bluenet.</p>
<p >A smartphone when setting up a connection has to perform a service discovery process. Bluetooth LE services and characteristics are obtained from the bluenet device. This process takes a while, a couple of seconds. The reason for this is that it is not truly possible to reliably cache the services and characteristics properly across all devices. If the device running bluenet that you want to connect to is not in the proximity of the smartphone, the connection process can take quite some while or fail altogether.</p>
<p >For this, the so-called <a href="https://github.com/crownstone/crownstone-app/blob/master/docs/bleTasks/ConstellationAPI.MD">ConstellationAPI</a> has been implemented. It sorts bluenet devices on their proximity and is able to set up a connection to a couple of them in parallel. The sessions are time-limited. You can send a series of different dim commands while using the dim slider without connecting and disconnecting within a certain time period.</p>
<p >There are no permanent connections. This might be something for the future to further remove delays.</p>
<ul>
<li>Register services and characteristics in the softdevice (the radio stack by the manufacturer).</li>
<li>Receive a connection request (will only handle a single simultaneous request for now).</li>
<li>Send session key.</li>
<li>Send session data.</li>
<li>Decrypt incoming control command.</li>
<li>Encrypt responses.</li>
<li>Send response over multiple notifications.</li>
<li>Done</li>
</ul>
<p >The disconnect is automatically after a timeout if not disconnected from the other side. The disconnect can also be done directly when an explicit disconnect command is sent.</p>
<h2><a class="anchor" id="autotoc_md82"></a>
Data channel packet</h2>
<p >The structure of a data channel packet over which the so-called attribute protocol (ATT) is defined, is as in the following picture and table. This splits out the Protocol Data Unit (PDU) from a Bluetooth LE packet (see above).</p>
<p ><img src="../docs/diagrams/att-packet.png" alt="ATT packet" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">LL header   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">Link layer header    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">L2CAP header   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Logical link control and adaptation protocol header    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">ATT header   </td><td class="markdownTableBodyNone">3   </td><td class="markdownTableBodyNone">Attribute header    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">ATT payload   </td><td class="markdownTableBodyNone">244   </td><td class="markdownTableBodyNone">Attribute data (0-244 bytes)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">MIC   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Message integrity check   </td></tr>
</table>
<p >The <code>LL</code> header can be split into multiple fields, but they are not relevant to the discussion. It contains e.g. information about the PDU type.</p>
<h1><a class="anchor" id="autotoc_md83"></a>
Receive connectionless commands</h1>
<p ><img src="../docs/diagrams/adv-packet.png" alt="Advertisement packet" class="inline"/></p>
<p >The structure of a packet over an advertisement channel (37, 38, or 39) is similar, but much smaller.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">LL header   </td><td class="markdownTableBodyNone">2   </td><td class="markdownTableBodyNone">Link layer header    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">MAC address   </td><td class="markdownTableBodyNone">4   </td><td class="markdownTableBodyNone">Address of the device that is advertising    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">Advertisement payload   </td><td class="markdownTableBodyNone">31   </td><td class="markdownTableBodyNone">Advertisement payload (if smaller, nonsignificant part is filled/padded by zeros)   </td></tr>
</table>
<p >There is no message integrity check. The advertisement payload can have multiple advertisement data blocks. Each of these have the following structure.</p>
<p ><img src="../docs/diagrams/adv-payload.png" alt="Advertisement payload" class="inline"/></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Type   </th><th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Length   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">AD length   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Advertisement data length    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">AD type   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Advertisement data type    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">uint8   </td><td class="markdownTableBodyNone">AD contents   </td><td class="markdownTableBodyNone">N   </td><td class="markdownTableBodyNone">Advertisement data contents (max 29 bytes)   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md84"></a>
Receive connectionless presence</h1>
<p >The format for advertisement payload packets can be found in the <a href="protocol/PROTOCOL.md#advertisements">protocol doc</a>. The more or less standardized iBeacon format is used for this, which is a couple of well-defined AD structures (see also section above).</p>
<p >The frequency with with those messages are sent is defined by the smartphone manufacturers. The fastest rate with which they are sent is every 20 ms. For tags or other devices this is often much less, say every couple of seconds.</p>
<p >On the bluenet side we try to scan most of the time for such packets. This makes it possible to respond fast.</p>
<h1><a class="anchor" id="autotoc_md85"></a>
Send connectionless state</h1>
<p >The device running bluenet can broadcast state information in an encrypted manner. Devices can pick up on e.g. data about real-time energy consumption in a vary fast manner (without the need to set up a connection). The smartphone or device scanning for this information might not be scanning all the time, so this should be considered a lossy way to broadcast status information.</p>
<h1><a class="anchor" id="autotoc_md86"></a>
Send connectionless presence</h1>
<p >The device running bluenet can broadcast iBeacon messages. The devices can then be used as anchor points for presence or positioning information.</p>
<h1><a class="anchor" id="autotoc_md87"></a>
Send and receive over mesh</h1>
<p >Details on how to send and receive over mesh can be found at the <a class="el" href="md_docs_MESH.html">mesh doc</a>.</p>
<h1><a class="anchor" id="autotoc_md88"></a>
Send connection commands</h1>
<p >A connection exists out of the following steps (on the smartphone side):</p>
<ul>
<li>Set up the connection.</li>
<li>Set the maximum transmission unit (MTU) of an ATT packet.</li>
<li>Discover services and characteristics.</li>
<li>Enable notifications.</li>
<li>Read the session key.</li>
<li>Read the session data.</li>
<li>Encrypt and write a control command.</li>
<li>Merge the incoming notifications that are returned.</li>
<li>Decrypt the merged data.</li>
<li>Done (disconnect).</li>
</ul>
<p >The firmware can already receive connection commands (see first section). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
