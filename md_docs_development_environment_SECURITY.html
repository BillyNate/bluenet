<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: Intro</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_development_environment_SECURITY.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Intro </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >First, if you have never read up on security, please watch some movies online on <a href="https://www.defcon.org/">Defcon</a>. On security and BLE we recommend <a href="https://media.ccc.de/v/33c3-8019-lockpicking_in_the_iot">this talk</a> by Ray. You will be quickly uptodate about all necessary tools, such as the ST-Link, Ubertooth, wireshark, smali, etc.</p>
<p ><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> approaches security from the perspective that YOU should be the OWNER of your devices including the firmware and the keys that come with it (see <a href="https://crownstone.rocks/2017/01/07/the-devilish-dilemma-of-supporting-android-and-ios-with-ble">blog post</a>). We are against security by obscurity. Note, for example that this means we at times do not integrate with third-party vendors if they hide their sloppy implementation under an NDA!</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Security feature   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Message encryption   </td><td class="markdownTableBodyNone">Every message, including advertisements are encrypted with AES128    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Usage leakage protection   </td><td class="markdownTableBodyNone">Each plug sends out advertisements, even if nothing happens    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Replay attack protection   </td><td class="markdownTableBodyNone">There are counters involved that make replay attacks much harder    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Close-range setup   </td><td class="markdownTableBodyNone">Minimize sniffing opportunities at the setup process    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Multiple keys   </td><td class="markdownTableBodyNone">There are several keys for different levels of access   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md238"></a>
Message encryption</h1>
<p ><a class="el" href="classAES.html" title="Class that implements AES encryption.">AES</a> is a symmetric cypher. This means that it applies a bunch of XORs that flip bits from ones to zeros and the other way around. On embedded hardware this is space and memory preserving because you can use the same functions for encryption and decryption. You can read more on <a class="el" href="classAES.html" title="Class that implements AES encryption.">AES</a> on <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">Wikipedia</a>. Using 128 bits is considered sufficient in the USA for information up to level SECRET. Nice note to the future quantum hacker, symmetric keys such as <a class="el" href="classAES.html" title="Class that implements AES encryption.">AES</a> seem to be <a href="https://en.wikipedia.org/wiki/Post-quantum_cryptography">quantum resistant</a>.</p>
<h1><a class="anchor" id="autotoc_md239"></a>
Usage leakage protection</h1>
<p >If our devices would only communicate if their state would change, it would inadvertently reveal information about the presence of someone at home, or their use of their devices.</p>
<h1><a class="anchor" id="autotoc_md240"></a>
Replay attack protection</h1>
<p >If someone captures a message that is intended for one of your switches/plugs and replays it a later time while you're not home for example, they will not be able to switch a light or repeat the action by just resending the capture message.</p>
<h1><a class="anchor" id="autotoc_md241"></a>
Close-range setup</h1>
<p >The setup process exchanges keys between the smartphone of the admin and the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> device itself. The signal strength of the radio is severely reduced before the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> is set up. This means that while you are configuring your devices the person listening in on that process must basically sit next to you at that specific (short) time window.</p>
<h1><a class="anchor" id="autotoc_md242"></a>
Multiple keys</h1>
<p >A device does have multiple keys. Not only the connections themselves, also the advertisements are encrypted with the keys on the device. The nodes that belong together in a network are organized in so-called "spheres". Hence, each sphere has a unique security key. The key that allows a user to decrypt the advertisements in a sphere is called the <b>guest key</b>. This means that a user with this access level can control the devices, they can also see the power consumption of devices and other state info. This key is the one that is exchanged with friends. It has to be seen as that key that will allow friends to control the devices just as in the case they are physically present. This key is also sufficient to decrypt the advertisements required for indoor localization. So, also for your friends the lights will remain on if they are in the living room. Another key, the <b>admin key</b> allows people to add guests to the household. The admin organizes most things around access and is typically the person who's the first user of the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> system. There is an intermediate <b>member key</b>. This is a key typical for other household members, who can for example set schedules for devices. The detailed permission levels can be read in the <a class="el" href="md_docs_protocol_PROTOCOL.html">Protocol doc</a>.</p>
<h1><a class="anchor" id="autotoc_md243"></a>
Considerations</h1>
<p >There are - regretfully - tradeoffs to make between security and usability.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Security-related decision   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">BLE 4.0   </td><td class="markdownTableBodyNone">iPhone 5 only supports 4.0 and has too big a market share    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Passwords   </td><td class="markdownTableBodyNone"><a class="el" href="classStorage.html" title="Class to store items persistently in flash (persistent) memory.">Storage</a> of hashed passwords in the app    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Factory reset   </td><td class="markdownTableBodyNone">Physical access means ability to factory reset    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Firmware   </td><td class="markdownTableBodyNone">Firmware checksum   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md244"></a>
BLE 4.0</h2>
<p >The setup process with BLE 4.2 can use <a href="https://en.wikipedia.org/wiki/Elliptic_curve_Diffie–Hellman">Elliptic curve Diffie-Helmann</a>. In other words, the proper way to exchange keys over an unsafe channel. However, the iPhone 5 only supports 4.0 and has a market share too big to ignore. For that reason we use a close-range setup process as explained above. As soon as BLE 4.2 is supported by all smartphone models we will be happy to migrate.</p>
<h2><a class="anchor" id="autotoc_md245"></a>
Passwords</h2>
<p >At first we only stored a token in the app. A token is obtained by a request to the cloud servers with username and password. However, if we invalidate tokens after a new username and password request this means that the simultaneous use of multiple devices or the simultaneous use of a device and a dashboard means that the user has to login time after time.</p>
<p >We therefore opted for storing the password in a hashed form in the app. It is the responsibility of the device owner not to install malicious apps that try to read across app boundaries on their smartphone / tablet. However, even so, the plain password will not be leaked.</p>
<h2><a class="anchor" id="autotoc_md246"></a>
Factory reset</h2>
<p >In our consumer products physical proximity means that the user is able to perform a factory reset. This is the most difficult security decision we had to make. In the end our reasoning has been the following: if someone is close enough to steal the device, they might as well be able to factory reset it. If that person subsequently reconfigures the device, it will have the wrong keys, so the rightful owner will notice if someone tampered with their devices. We might remove this function in the future, but then people run the risk in bricking their own devices by loosing their keys. If someone has a good suggestion for this scenario that is convenient and secure at the same time, contact us!</p>
<p >Think of the following scenarios:</p>
<ul>
<li>a divorce gone wrong, and although he left, he locked you out from using your own devices/lights;</li>
<li>losing your smartphone plus the login information to the cloud;</li>
<li>bringing your own devices to your new home.</li>
</ul>
<p >Note that the time window in which someone can perform a factory reset is very limited. It is only within around 30 seconds after the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> is powered on. You won't be able to do it by just being close alone, you have to switch off the power to that <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a> as well.</p>
<h2><a class="anchor" id="autotoc_md247"></a>
Firmware</h2>
<p >There is currently no firmware checksum applied. We are of the opinion that you should be able to put whatever firmware you like on our devices.</p>
<h1><a class="anchor" id="autotoc_md248"></a>
There are TODOs!</h1>
<p >Yes, there are TODOs.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Security todos   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Retract access   </td><td class="markdownTableBodyNone">On retracting a guest access key, this key needs to be renewed   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md249"></a>
Retract access</h2>
<p >Suppose you have given your friend a key, but your friend is your friend not anymore. This means that this key needs to be renewed if that same key is used by a group of your friends. The alternative would be separate keys for any person, however, that does not scale up if you have many friends. :-)</p>
<p >Moreover, we have to encrypt the advertisements with the same key or else no one will be able to read them except for the owner. Hence, the only logical solution is to re-roll the encryption keys on every mutation of the guest list. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
