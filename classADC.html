<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: ADC Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">1.5.1</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="classADC-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">ADC Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Analog-Digital conversion.  
 <a href="classADC.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="cs__ADC_8h_source.html">cs_ADC.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a98de884659716003ce95901b8024ca57"><td class="memItemLeft" align="right" valign="top">cs_adc_error_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#a98de884659716003ce95901b8024ca57">init</a> (const <a class="el" href="structadc__config__t.html">adc_config_t</a> &amp;config)</td></tr>
<tr class="memdesc:a98de884659716003ce95901b8024ca57"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a>.  <a href="#a98de884659716003ce95901b8024ca57">More...</a><br /></td></tr>
<tr class="separator:a98de884659716003ce95901b8024ca57"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a77afa039c73f7e50d04fe64e8e79d412"><td class="memItemLeft" align="right" valign="top"><a id="a77afa039c73f7e50d04fe64e8e79d412"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#a77afa039c73f7e50d04fe64e8e79d412">start</a> ()</td></tr>
<tr class="memdesc:a77afa039c73f7e50d04fe64e8e79d412"><td class="mdescLeft">&#160;</td><td class="mdescRight">Start the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> sampling. <br /></td></tr>
<tr class="separator:a77afa039c73f7e50d04fe64e8e79d412"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af92b34ed7a2ed66b1da7858a58faf140"><td class="memItemLeft" align="right" valign="top"><a id="af92b34ed7a2ed66b1da7858a58faf140"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#af92b34ed7a2ed66b1da7858a58faf140">stop</a> ()</td></tr>
<tr class="memdesc:af92b34ed7a2ed66b1da7858a58faf140"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stop the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> sampling. <br /></td></tr>
<tr class="separator:af92b34ed7a2ed66b1da7858a58faf140"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad4fef81b54aa4407903c5edb7b74da8d"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#ad4fef81b54aa4407903c5edb7b74da8d">releaseBuffer</a> (nrf_saadc_value_t *buf)</td></tr>
<tr class="memdesc:ad4fef81b54aa4407903c5edb7b74da8d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Release a buffer, so it can be used again by the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a>.  <a href="#ad4fef81b54aa4407903c5edb7b74da8d">More...</a><br /></td></tr>
<tr class="separator:ad4fef81b54aa4407903c5edb7b74da8d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7f2a9a7bd30cc52ae89857573ebd8be0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#a7f2a9a7bd30cc52ae89857573ebd8be0">setDoneCallback</a> (adc_done_cb_t callback)</td></tr>
<tr class="memdesc:a7f2a9a7bd30cc52ae89857573ebd8be0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the callback which is called when a buffer is filled.  <a href="#a7f2a9a7bd30cc52ae89857573ebd8be0">More...</a><br /></td></tr>
<tr class="separator:a7f2a9a7bd30cc52ae89857573ebd8be0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a58275fd62a44a1138ab44366914f92b4"><td class="memItemLeft" align="right" valign="top"><a id="a58275fd62a44a1138ab44366914f92b4"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>enableZeroCrossingInterrupt</b> (cs_adc_channel_id_t channel, int32_t zeroVal)</td></tr>
<tr class="separator:a58275fd62a44a1138ab44366914f92b4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5bb4f20e32687098ec4d99b76c473b17"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#a5bb4f20e32687098ec4d99b76c473b17">setZeroCrossingCallback</a> (adc_zero_crossing_cb_t callback)</td></tr>
<tr class="memdesc:a5bb4f20e32687098ec4d99b76c473b17"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the callback which is called when a buffer is filled.  <a href="#a5bb4f20e32687098ec4d99b76c473b17">More...</a><br /></td></tr>
<tr class="separator:a5bb4f20e32687098ec4d99b76c473b17"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afe32c24ec01cea1b112f440eb72f614f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#afe32c24ec01cea1b112f440eb72f614f">_handleAdcDoneInterrupt</a> (nrf_saadc_value_t *buf)</td></tr>
<tr class="memdesc:afe32c24ec01cea1b112f440eb72f614f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Update this object with a buffer with values from the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> conversion.  <a href="#afe32c24ec01cea1b112f440eb72f614f">More...</a><br /></td></tr>
<tr class="separator:afe32c24ec01cea1b112f440eb72f614f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3eda91590d8282a90a6717db296d0d5d"><td class="memItemLeft" align="right" valign="top"><a id="a3eda91590d8282a90a6717db296d0d5d"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>_handleAdcLimitInterrupt</b> (nrf_saadc_limit_t type)</td></tr>
<tr class="separator:a3eda91590d8282a90a6717db296d0d5d"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:a314f14380849b63758a4f919d2a3321f"><td class="memItemLeft" align="right" valign="top"><a id="a314f14380849b63758a4f919d2a3321f"></a>
static <a class="el" href="classADC.html">ADC</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#a314f14380849b63758a4f919d2a3321f">getInstance</a> ()</td></tr>
<tr class="memdesc:a314f14380849b63758a4f919d2a3321f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Use static variant of singleton, no dynamic memory allocation. <br /></td></tr>
<tr class="separator:a314f14380849b63758a4f919d2a3321f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Analog-Digital conversion. </p>
<p>The <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> is a hardware peripheral that can be initialized for a particular pin. Subsequently, the analog signal is converted into a digital value. The resolution of the conversion is limited (default 10 bits). The conversion is used to get the current curve.</p>
<p>There is only one <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> hardware peripheral, hence this class conforms to the singleton design pattern.</p>
<p>The constructor does NOT have arguments you might expect, such as the number of buffers to use, or the size of the buffers. These are all set through preprocessor macros. The <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> class requires access to the following macros (see below).</p>
<p>The timer used to get new samples on regular time intervals. The timer should be able to run on at least 2kHz to be able to get the fine-grained current and voltage data we want.</p>
<ul>
<li>CS_ADC_TIMER The timer peripheral to use for the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> peripheral.</li>
<li>CS_ADC_INSTANCE_INDEX The instance id of the timer. TODO: What is this?</li>
<li>CS_ADC_TIMER_ID TODO: What is this?</li>
</ul>
<p>The buffers to be used internally. To have these buffers in the form of macros means that we can check at compile time if they are small enough with respect to the nRF52 memory limitations.</p>
<ul>
<li>CS_ADC_NUM_BUFFERS The number of <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> buffers to use.</li>
<li>CS_ADC_BUF_SIZE The size of the buffer (first time used in <a class="el" href="classADC.html#a98de884659716003ce95901b8024ca57" title="Initialize ADC. ">init()</a>).</li>
</ul>
<p>The pins:</p>
<ul>
<li>CS_ADC_MAX_PINS The maximum number of pins available for <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a>.</li>
</ul>
<p>The sequence of events is as follows:</p>
<ol type="1">
<li>The C interrupt service routine, saadc_callback(nrf_drv_saadc_evt_t const * p_event) can be found in the corresponding implementation file. This function uses the singleton feature to call update on an event from the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> peripheral, in particular, NRF_DRV_SAADC_EVT_DONE, with a buffer as argument.</li>
<li>The update() routine puts an internal C function, adc_done, with _doneCallback as argument in the event queue of the scheduler. This calls the callback function set previously in <a class="el" href="classADC.html#a7f2a9a7bd30cc52ae89857573ebd8be0" title="Set the callback which is called when a buffer is filled. ">setDoneCallback()</a> by a particular caller, e.g. the cs_PowerSampling. In this particular case it ends up in <a class="el" href="classPowerSampling.html#ad0eab4314d0b6f14333b8982bc317194" title="Called when the sample burst is finished. ">PowerSampling::powerSampleAdcDone</a> that after processing the data calls releaseBuffer(bufNum).</li>
<li>The releaseBuffer function clears the _doneCallbackData structure and queues a new buffer. Note that all processing has taken place by now.</li>
</ol>
<p>Note. In the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> it is assumed that the member object is not updated (_doneCallbackData.bufName == bufNum) in the mean while. In other words, it should not be possible to get a second interrupt before releaseBuffer has been called. Scheduling a new <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> task is only done at the end of the releaseBuffer function. </p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a id="afe32c24ec01cea1b112f440eb72f614f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afe32c24ec01cea1b112f440eb72f614f">&#9670;&nbsp;</a></span>_handleAdcDoneInterrupt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ADC::_handleAdcDoneInterrupt </td>
          <td>(</td>
          <td class="paramtype">nrf_saadc_value_t *&#160;</td>
          <td class="paramname"><em>buf</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Update this object with a buffer with values from the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> conversion. </p>
<p>This update() function is also called from the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> interrupt service routine. In this case an entire buffer has been made available. This is done by having the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> peripheral directly writing into a part of the FLASH using the Easy-DMA peripheral and inter-peripheral communication (called PPI). Note that this function is time-sensitive. The number of activities in it are limited to a minimal number. The values are only copied and not processed further.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">buf</td><td>A buffer with size defined in the constructor. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a98de884659716003ce95901b8024ca57"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a98de884659716003ce95901b8024ca57">&#9670;&nbsp;</a></span>init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cs_adc_error_t ADC::init </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="structadc__config__t.html">adc_config_t</a> &amp;&#160;</td>
          <td class="paramname"><em>config</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">config</td><td>Config struct. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Error code (0 means success). </dd></dl>

</div>
</div>
<a id="ad4fef81b54aa4407903c5edb7b74da8d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad4fef81b54aa4407903c5edb7b74da8d">&#9670;&nbsp;</a></span>releaseBuffer()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool ADC::releaseBuffer </td>
          <td>(</td>
          <td class="paramtype">nrf_saadc_value_t *&#160;</td>
          <td class="paramname"><em>buf</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Release a buffer, so it can be used again by the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">buf</td><td>Pointer to the buffer, as received in the done callback. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Boolean indicating success (true) or failure (false). </dd></dl>

</div>
</div>
<a id="a7f2a9a7bd30cc52ae89857573ebd8be0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7f2a9a7bd30cc52ae89857573ebd8be0">&#9670;&nbsp;</a></span>setDoneCallback()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ADC::setDoneCallback </td>
          <td>(</td>
          <td class="paramtype">adc_done_cb_t&#160;</td>
          <td class="paramname"><em>callback</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set the callback which is called when a buffer is filled. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">callback</td><td>Function to be called when a buffer is filled with samples. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a5bb4f20e32687098ec4d99b76c473b17"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5bb4f20e32687098ec4d99b76c473b17">&#9670;&nbsp;</a></span>setZeroCrossingCallback()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ADC::setZeroCrossingCallback </td>
          <td>(</td>
          <td class="paramtype">adc_zero_crossing_cb_t&#160;</td>
          <td class="paramname"><em>callback</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set the callback which is called when a buffer is filled. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">callback</td><td>Function to be called on a zero crossing event. This function will run at interrupt level! </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>include/drivers/<a class="el" href="cs__ADC_8h_source.html">cs_ADC.h</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
