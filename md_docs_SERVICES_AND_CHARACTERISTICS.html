<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluenet: Service and characteristics</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
	DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">5.4.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_SERVICES_AND_CHARACTERISTICS.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="classService.html" title="Service as defined in the GATT Specification.">Service</a> and characteristics </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This document describes how services and characteristics are implemented in bluenet.</p>
<h1><a class="anchor" id="autotoc_md66"></a>
Services</h1>
<p >Every service can add multiple characteristics. It should do so in <code>createCharacteristics()</code>. The characteristics should use the service <a class="el" href="classUUID.html" title="Class that enables the use of 128 bit service UUIDs.">UUID</a> as base.</p>
<h1><a class="anchor" id="autotoc_md67"></a>
Characteristics</h1>
<p >There are many different characteristic classes, each for a different value type. These classes are specializations of the templated <a class="el" href="classCharacteristicGeneric.html" title="Characteristic of generic type T.">CharacteristicGeneric</a>. All classes are derivatives of <a class="el" href="classCharacteristicBase.html" title="Non-template base class for Characteristics.">CharacteristicBase</a>.</p>
<p >Right now, only a few different types are used:</p><ul>
<li><code><a class="el" href="classCharacteristic.html" title="A default characteristic.">Characteristic</a>&lt;buffer_ptr_t&gt;</code></li>
<li><code><a class="el" href="classCharacteristic.html" title="A default characteristic.">Characteristic</a>&lt;uint32_t&gt;</code></li>
<li><code><a class="el" href="classCharacteristic.html" title="A default characteristic.">Characteristic</a>&lt;std::string&gt;</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md68"></a>
Buffers</h1>
<p >Every characteristic needs a read and/or write buffer. This buffer is used by the softdevice, and is what the connected device reads or writes. In the code, these are often called "gattValue".</p>
<p >Because the buffers that the connected device can read or write should be encrypted, these buffers should not be the same as the unencrypted buffers.</p>
<p >Which buffers are used, is determined by the service implementation, and the type of characteristic.</p>
<p >To reduce the amount of buffers, there are some buffers that are reused. <a class="el" href="classCrownstoneCentral.html" title="Class to connect to another crownstone, and write control commands.">CrownstoneCentral</a> can use them as well, since there can be only 1 connection: either outgoing or incoming. It is still important though, not to write unencrypted data to the encryption buffer.</p>
<h2><a class="anchor" id="autotoc_md69"></a>
CharacteristicWriteBuffer</h2>
<p >Initialized by <a class="el" href="classStack.html" title="nRF51822 specific implementation of the BLEStack">Stack</a>.</p>
<p >Used by:</p><ul>
<li><a class="el" href="classStack.html" title="nRF51822 specific implementation of the BLEStack">Stack</a><ul>
<li>For incoming long writes, this buffer is returned when the softdevice requests memory.</li>
</ul>
</li>
<li>Control characteristic<ul>
<li>For incoming writes. I believe this matches the softdevice memory request.</li>
</ul>
</li>
<li><a class="el" href="classCrownstoneCentral.html" title="Class to connect to another crownstone, and write control commands.">CrownstoneCentral</a><ul>
<li>For outgoing writes, since a write goes in chunks, and thus the data to write must be retained.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md70"></a>
CharacteristicReadBuffer</h2>
<p >Initialized by <a class="el" href="classStack.html" title="nRF51822 specific implementation of the BLEStack">Stack</a>.</p>
<p >Used by:</p><ul>
<li>Result characteristic</li>
<li>Session data characteristic</li>
<li><a class="el" href="classCrownstoneCentral.html" title="Class to connect to another crownstone, and write control commands.">CrownstoneCentral</a><ul>
<li>To decrypt the merged incoming notifications to.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md71"></a>
EncryptionBuffer</h2>
<p >Initialized by <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration.">Crownstone</a>.</p>
<p >Used by:</p><ul>
<li><a class="el" href="classCrownstoneCentral.html" title="Class to connect to another crownstone, and write control commands.">CrownstoneCentral</a><ul>
<li>To merge multiple incoming notifications to.</li>
</ul>
</li>
<li><a class="el" href="classBleCentral.html" title="Class that enables you to connect to a device, and perform write or read operations.">BleCentral</a><ul>
<li>To read and write (because we usually read and write encrypted data).</li>
</ul>
</li>
<li>Any characteristic with <code>(_minAccessLevel &lt; ENCRYPTION_DISABLED)</code>, <code>_status.sharedEncryptionBuffer</code>, and <code>_status.aesEncrypted</code>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md72"></a>
Usage and implementation details</h1>
<ul>
<li>When <code>sharedEncryptionBuffer</code> is false, a separate encryption buffer will be allocated.</li>
<li>updateValue() will encrypt the value of a characteristic to the encrypted buffer. Also, when notifications are enabled, it will start notifying the value.</li>
</ul>
<h1><a class="anchor" id="autotoc_md73"></a>
Notifications</h1>
<p >When the value is updated, it can be notified in chunks, as notifications are of limited size. Each time, onTxComplete, the next chunk is notified. This means that the gatt value buffer is read until the last part is notified.</p>
<h1><a class="anchor" id="autotoc_md74"></a>
Long write</h1>
<p >When large buffer is written to a characteristic, it's called a long write. A long write is written in chunks by multiple "prepare write requests", then finalized by "execute write request". See this <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fcom.nordic.infocenter.s132.api.v6.1.1%2Fgroup___b_l_e___g_a_t_t_s___q_u_e_u_e_d___w_r_i_t_e___b_u_f___n_o_a_u_t_h___m_s_c.html">sequence diagram</a>.</p>
<p >When the first request is received, the softdevice will request memory to store the different requests. Multiple characteristics can be written with a single long write, which is why the execute write request event does not contain an characteristic handle.</p>
<p >Right now, bluenet assumes only 1 characteristic was written. Also, bluenet gets the handle from the raw buffer (see <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fcom.nordic.infocenter.s132.api.v5.0.0%2Fgroup___b_l_e___g_a_t_t_s___q_u_e_u_e_d___w_r_i_t_e_s___u_s_e_r___m_e_m.html&amp;cp=2_3_1_1_0_2_4_5">memory layout</a>) that was given on memory request. The latter could be avoided by using <code>sd_ble_gatts_value_get()</code> instead. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
